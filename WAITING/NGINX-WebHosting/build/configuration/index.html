<!DOCTYPE html>
<html>
<head>
<!-- TrustArc handles cookie consent and is a prerequisite for loading Tealium -->
<script async="async" src="https://consent.trustarc.com/notice?domain=f5.com&c=teconsent&js=nj&noticeType=bb&text=true&gtm=1" crossorigin=""></script>
<!-- Tealium profile utag.sync.js script -->
<script src="https://mktg.tags.f5.com/nginx-unit/prod/utag.sync.js"></script>
<!-- End TrustArc/Tealium -->

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://unit.nginx.org/configuration/">
<meta property="og:title" content="NGINX Unit: Configuration">
<meta content="Create and maintain a working configuration using listeners, routes, apps, and upstreams." name="og:description" />

<meta property="og:image" content="http://unit.nginx.org/_static/logo.png?e39b3bbae06cd8bdb5a7814270161b52">
<meta property="og:image:secure_url" content="https://unit.nginx.org/_static/logo.png?e39b3bbae06cd8bdb5a7814270161b52">
<meta property="og:image:width" content="988">
<meta property="og:image:height" content="357">
<meta property="og:image:alt" content="NGINX Unit logo" />
<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">

<style>
/* open-sans-regular - latin_latin-ext */
@font-face {
  font-display: swap;
  font-family: 'Open Sans';
  font-style: normal;
  font-weight: 400;
  src: local('OpenSans'), local('Open Sans'), local('Open Sans Regular'), local('OpenSans-Regular'),
       url('../_static/open-sans-v40-latin_latin-ext-regular.woff2?058e68d126ca347a4db54933db4738db') format('woff2');
}

/* open-sans-italic - latin_latin-ext */
@font-face {
  font-display: swap;
  font-family: 'Open Sans';
  font-style: italic;
  font-weight: 400;
  src: local('OpenSansItalic'), local('Open Sans Italic'), local('OpenSans Italic'), local('OpenSans-Italic'),
       url('../_static/open-sans-v40-latin_latin-ext-italic.woff2?86b58c2ae26455092651312b8582674f') format('woff2');
}

/* open-sans-700 - latin_latin-ext */
@font-face {
  font-display: swap;
  font-family: 'Open Sans';
  font-style: normal;
  font-weight: 700;
  src: local('OpenSansBold'), local('Open Sans Bold'), local('OpenSans Bold'), local('OpenSans-Bold'),
       url('../_static/open-sans-v40-latin_latin-ext-700.woff2?40654e941d643aead74c5d6a56a38c6b') format('woff2');
}

/* open-sans-700italic - latin_latin-ext */
@font-face {
  font-display: swap;
  font-family: 'Open Sans';
  font-style: italic;
  font-weight: 700;
  src: local('OpenSansBoldItalic'), local('Open Sans Bold Italic'), local('OpenSans Bold Italic'), local('OpenSans-BoldItalic'), local('OpenSans-Bold-Italic'),
       url('../_static/open-sans-v40-latin_latin-ext-700italic.woff2?e4fada57efe79e0fb447a7dc076a568b') format('woff2');
}

</style>
<link rel="stylesheet" href="../_static/style.css?02b1052daea25a810283ecaa29bc2462" />
<link rel="icon" href="../_static/icon.png?26255dfe9094cf47412c8b5d3757467b" />
<link rel="alternate" type="application/rss+xml" title="Subscribe to NGINX Unit News" href="https://unit.nginx.org/rss.xml" />
<script async src="../_static/script.js?8dc8ff30c396ce882326156b1581000a"></script>
<link rel="next" title="Scripting" href="../scripting/" />
<link rel="prev" title="Control API" href="../controlapi/" />

<title>Configuration — NGINX Unit</title>
</head>
<body>
<!-- Tealium Universal Tag -->
<script type="text/javascript">
  (function(a,b,c,d) {
      a='//mktg.tags.f5.com/nginx-unit/prod/utag.js';
      b=document;c='script';d=b.createElement(c);d.src=a;
      d.type='text/java'+c;d.async=true;
      a=b.getElementsByTagName(c)[0];a.parentNode.insertBefore(d,a)})();
</script>
<!-- End Tealium Universal Tag -->

<!-- Global banner goes here
    <div id="rennab"><a href="BANNER LINK">BANNER TEXT</a></div>
-->
<div id="main">
<div id="side">
    <h1>
        <a href="../">
            <img src="../_static/logo.svg?ea753eb2210f855447af3b2367898f85" alt="NGINX Unit" />
        </a>
        
        <div id="version_link" title="Released on Sep 18, 2024">
         <a style="text-decoration:none;" href="../news/2024/unit-1.33.0-released/">v. 1.33.0</a>
         </div>
    </h1>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../keyfeatures/">Key features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../news/">News</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../controlapi/">Control API</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#listeners">Listeners</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#ssl-tls-configuration">SSL/TLS configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ip-protocol-forwarding">IP, protocol forwarding</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overwriting-protocol-scheme">Overwriting protocol scheme</a></li>
<li class="toctree-l4"><a class="reference internal" href="#originating-ip-identification">Originating IP identification</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#routes">Routes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#route-steps">Route steps</a></li>
<li class="toctree-l3"><a class="reference internal" href="#matching-conditions">Matching conditions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#match-resolution">Match resolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pattern-syntax">Pattern syntax</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#handling-actions">Handling actions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#variables">Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#uri-rewrite">URI rewrite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#response-headers">Response headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#instant-responses-redirects">Instant responses, redirects</a></li>
<li class="toctree-l2"><a class="reference internal" href="#static-files">Static files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#mime-filtering">MIME filtering</a></li>
<li class="toctree-l3"><a class="reference internal" href="#path-restrictions">Path restrictions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fallback-action">Fallback action</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#proxying">Proxying</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#load-balancing">Load balancing</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#applications">Applications</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#process-management">Process management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#process-isolation">Process isolation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#request-limits">Request limits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#application-processes">Application processes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#go">Go</a></li>
<li class="toctree-l3"><a class="reference internal" href="#java">Java</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-js">Node.js</a></li>
<li class="toctree-l3"><a class="reference internal" href="#perl">Perl</a></li>
<li class="toctree-l3"><a class="reference internal" href="#php">PHP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#targets">Targets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#python">Python</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration-python-targets">Targets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ruby">Ruby</a></li>
<li class="toctree-l3"><a class="reference internal" href="#webassembly">WebAssembly</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#unit-wasm-wasm-wasi-component">wasm-wasi-component</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unit-wasm-unit-wasm">unit-wasm</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#settings">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#access-log">Access log</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-log-formatting">Custom log formatting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conditional-access-log">Conditional access log</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../scripting/">Scripting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../certificates/">SSL/TLS certificates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../statusapi/">Status API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unitctl/">CLI (unitctl)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/">How-to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../community/">Community</a></li>
</ul>

</div>
<div id="content">
    
  <div class="section" id="configuration">
<h1>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading">§</a></h1>
<p>The <strong>/config</strong> section of the
<a class="reference internal" href="../controlapi/#configuration-api"><span class="std std-ref">control API</span></a>
handles Unit’s general configuration with entities such as
<a class="reference internal" href="#configuration-listeners"><span class="std std-ref">listeners</span></a>,
<a class="reference internal" href="#configuration-routes"><span class="std std-ref">routes</span></a>,
<a class="reference internal" href="#configuration-applications"><span class="std std-ref">applications</span></a>,
or
<a class="reference internal" href="#configuration-upstreams"><span class="std std-ref">upstreams</span></a>.</p>
<div class="section" id="listeners">
<span id="configuration-listeners"></span><h2>Listeners<a class="headerlink" href="#listeners" title="Permalink to this heading">§</a></h2>
<p>To accept requests,
add a listener object in the <strong>config/listeners</strong> API section;
the object’s name can be:</p>
<ul class="simple">
<li>A unique IP socket:
<strong>127.0.0.1:80</strong>, <strong>[::1]:8080</strong></li>
<li>A wildcard that matches any host IPs on the port:
<strong>*:80</strong></li>
<li><dl class="first docutils">
<dt>On Linux-based systems,</dt><dd><a class="reference external" href="https://man7.org/linux/man-pages/man7/unix.7.html">abstract UNIX sockets</a>
can be used as well:
<strong>unix:&#64;abstract_socket</strong>.</dd>
</dl>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Also on Linux-based systems,
wildcard listeners can’t overlap with other listeners
on the same port
due to rules imposed by the kernel.
For example, <strong>*:8080</strong> conflicts with <strong>127.0.0.1:8080</strong>;
in particular,
this means <strong>*:8080</strong> can’t be <em>immediately</em> replaced
by <strong>127.0.0.1:8080</strong>
(or vice versa)
without deleting it first.</p>
</div>
<p>Unit dispatches the requests it receives
to destinations referenced by listeners.
You can plug several listeners into one destination
or use a single listener
and hot-swap it between multiple destinations.</p>
<p>Available listener options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>pass</strong> (required)</td>
<td><p class="first">Destination to which the listener passes incoming requests.
Possible alternatives:</p>
<ul class="simple">
<li><a class="reference internal" href="#configuration-applications"><span class="std std-ref">Application</span></a>:
<strong>applications/qwk2mart</strong></li>
<li><a class="reference internal" href="#configuration-php-targets"><span class="std std-ref">PHP target</span></a>
or
<a class="reference internal" href="#configuration-python-targets"><span class="std std-ref">Python target</span></a>:
<strong>applications/myapp/section</strong></li>
<li><a class="reference internal" href="#configuration-routes"><span class="std std-ref">Route</span></a>:
<strong>routes/route66</strong>, <strong>routes</strong></li>
<li><a class="reference internal" href="#configuration-upstreams"><span class="std std-ref">Upstream</span></a>:
<strong>upstreams/rr-lb</strong></li>
</ul>
<p class="last">The value is
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variable</span></a>
-interpolated;
if it matches no configuration entities after interpolation,
a 404 “Not Found” response is returned.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>forwarded</strong></td>
<td>Object;
configures client IP address and protocol
<a class="reference internal" href="#configuration-listeners-forwarded"><span class="std std-ref">replacement</span></a>.</td>
</tr>
<tr class="row-even"><td><strong>tls</strong></td>
<td>Object;
defines SSL/TLS
<a class="reference internal" href="#configuration-listeners-ssl"><span class="std std-ref">settings</span></a>.</td>
</tr>
<tr class="row-odd"><td><strong>backlog</strong></td>
<td><p class="first">Integer;
controls the ‘backlog’ parameter to the <em>listen(2)</em> system-call.
This essentially limits the number of pending connections waiting
to be accepted.</p>
<p>The default varies by system.</p>
<p>On Linux, FreeBSD, OpenBSD and macOS the default is <strong>-1</strong> which
means use the OS default. For example. on Linux since 5.4, this is
<strong>4096</strong> (previously <strong>128</strong>) and on FreeBSD it’s <strong>128</strong>.</p>
<p>On other systems the default is <strong>511</strong>.</p>
<p>NOTE: Whatever limit you set here will be limited by the OS
system-wide sysctl. For example. on Linux that is
<strong>net.core.somaxconn</strong> and on BSD it’s <strong>kern.ipc.somaxconn</strong></p>
<p class="last"><em>(since 1.33.0)</em></p>
</td>
</tr>
</tbody>
</table>
<p>Here, a local listener accepts requests at port 8300
and passes them to the <strong>blogs</strong> app
<a class="reference internal" href="#configuration-php-targets"><span class="std std-ref">target</span></a>
identified by the <strong>uri</strong>
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variable</span></a>.
The wildcard listener on port 8400
relays requests at any host IPs
to the <strong>main</strong>
<a class="reference internal" href="#configuration-routes"><span class="std std-ref">route</span></a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;127.0.0.1:8300&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/blogs<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;*:8400&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes/main&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Also, <strong>pass</strong> values can be
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent encoded</a>.
For example, you can escape slashes in entity names:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes/slashes%2Fin%2Froute%2Fname&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;slashes/in/route/name&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="ssl-tls-configuration">
<span id="configuration-listeners-ssl"></span><h3>SSL/TLS configuration<a class="headerlink" href="#ssl-tls-configuration" title="Permalink to this heading">§</a></h3>
<p>The <strong>tls</strong> object provides the following options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>certificate</strong> (required)</td>
<td>String or an array of strings;
refers to one or more
<a class="reference internal" href="../certificates/#configuration-ssl"><span class="std std-ref">certificate bundles</span></a>
uploaded earlier,
enabling secure communication via the listener.</td>
</tr>
<tr class="row-odd"><td><strong>conf_commands</strong></td>
<td><p class="first">Object;
defines the OpenSSL
<a class="reference external" href="https://www.openssl.org/docs/manmaster/man3/SSL_CONF_cmd.html">configuration commands</a>
to be set for the listener.</p>
<p>To have this option,
Unit must be built and run with OpenSSL 1.0.2+:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>version

<span class="go">      OpenSSL 1.1.1d  10 Sep 2019</span>
</pre></div>
</div>
<p class="last">Also, make sure your OpenSSL version supports the commands
set by this option.</p>
</td>
</tr>
<tr class="row-even"><td><strong>session</strong></td>
<td>Object; configures the TLS session cache and tickets
for the listener.</td>
</tr>
</tbody>
</table>
<p>To use a certificate bundle you
<a class="reference internal" href="../certificates/#configuration-ssl"><span class="std std-ref">uploaded</span></a>
earlier,
name it in the <strong>certificate</strong> option of the <strong>tls</strong> object:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;127.0.0.1:443&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/wsgi-app&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;certificate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Certificate bundle name">bundle</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<details id=conf-bundles_
            onclick="window.location.hash='#conf-bundles'">
            <summary><span>Configuring multiple bundles</span></summary><div class="docutils container">
<p>Since version 1.23.0,
Unit supports configuring
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc6066#section-3">Server Name Indication (SNI)</a>
on a listener
by supplying an array of certificate bundle names
for the <strong>certificate</strong> option value:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;*:443&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;tls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;certificate&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;bundleA&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;bundleB&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;bundleC&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li>If the connecting client sends a server name,
Unit responds with the matching certificate bundle.</li>
<li>If the name matches several bundles,
exact matches have priority over wildcards;
if this doesn’t help, the one listed first is used.</li>
<li>If there’s no match or no server name was sent, Unit uses
the first bundle on the list.</li>
</ul>
</div>
</details><p>To set custom OpenSSL
<a class="reference external" href="https://www.openssl.org/docs/manmaster/man3/SSL_CONF_cmd.html">configuration commands</a>
for a listener,
use the <strong>conf_commands</strong> object in <strong>tls</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;tls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;certificate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Certificate bundle name">bundle</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;conf_commands&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;ciphersuites&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Mandatory cipher suites as per RFC8446, section 9.1">TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256</span>&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;minprotocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;TLSv1.3&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="configuration-listeners-ssl-sessions">The <strong>session</strong> object in <strong>tls</strong>
configures the session settings of the listener:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>cache_size</strong></td>
<td><p class="first">Integer;
sets the number of sessions in the TLS session cache.</p>
<p class="last">The default is <strong>0</strong>
(caching is disabled).</p>
</td>
</tr>
<tr class="row-odd"><td><strong>tickets</strong></td>
<td><p class="first">Boolean, string, or an array of strings;
configures TLS session tickets.</p>
<p class="last">The default is <strong>false</strong>
(tickets are disabled).</p>
</td>
</tr>
<tr class="row-even"><td><strong>timeout</strong></td>
<td><p class="first">Integer;
sets the session timeout for the TLS session cache.</p>
<p>When a new session is created,
its lifetime derives from current time and <strong>timeout</strong>.
If a cached session is requested past its lifetime,
it is not reused.</p>
<p class="last">The default is <strong>300</strong>
(5 minutes).</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;tls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;certificate&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Certificate bundle name">bundle</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;cache_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10240</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tickets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;k5qMHi7IMC7ktrPY3lZ+sL0Zm8oC0yz6re+y/zCj0H0/sGZ7yPBwGcb77i5vw6vCx8vsQDyuvmFb6PZbf03Auj/cs5IHDTYkKIcfbwz6zSU=&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;3Cy+xMFsCjAek3TvXQNmCyfXCnFNAcAOyH5xtEaxvrvyyCS8PJnjOiq2t4Rtf/Gq&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;8dUI0x3LRnxfN0miaYla46LFslJJiBDNdFiPJdqr37mYQVIzOWr+ROhyb1hpmg/QCM2qkIEWJfrJX3I+rwm0t0p4EGdEVOXQj7Z8vHFcbiA=&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <strong>tickets</strong> option works as follows:</p>
<ul>
<li><p class="first">Boolean values enable or disable session tickets;
with <strong>true</strong>, a random session ticket key is used:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;tickets&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc"><span class=nxt_hint title="Enables session tickets">true</span></span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">A string enables tickets
and explicitly sets the session ticket key:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;<span class=nxt_hint title="Enables session tickets, sets a single session ticket key">tickets</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IAMkP16P8OBuqsijSDGKTpmxrzfFNPP4EdRovXH2mqstXsodPC6MqIce5NlMzHLP&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This enables ticket reuse in scenarios
where the key is shared between individual servers.</p>
<details id=key-rotation_
            onclick="window.location.hash='#key-rotation'">
            <summary><span>Shared key rotation</span></summary><div class="docutils container">
<p>If multiple Unit instances need to recognize tickets
issued by each other
(for example, when running behind a load balancer),
they should share session ticket keys.</p>
<p>For example,
consider three SSH-enabled servers named <strong>unit*.example.com</strong>,
with Unit installed and identical <strong>*:443</strong> listeners configured.
To configure a single set of three initial keys on each server:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">SERVERS</span><span class="o">=</span><span class="s2">&quot;unit1.example.com</span>
<span class="s2">unit2.example.com</span>
<span class="s2">unit3.example.com&quot;</span>

<span class="nv">KEY1</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">48</span><span class="k">)</span>
<span class="nv">KEY2</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">48</span><span class="k">)</span>
<span class="nv">KEY3</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">48</span><span class="k">)</span>

<span class="k">for</span><span class="w"> </span>SRV<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$SERVERS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ssh<span class="w"> </span><span class=nxt_hint title="Assuming Unit runs as root on each server">root</span>@<span class="nv">$SRV</span><span class="w">  </span><span class="se">\</span>
<span class="w">        </span>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;[&quot;$KEY1&quot;, &quot;$KEY2&quot;, &quot;$KEY3&quot;]&#39;</span><span class="w"> </span>--unix-socket<span class="w"> </span><span class=nxt_ph title="Path to the remote control socket">/path/to/control.unit.sock</span><span class="w">  </span><span class="se">\</span>
<span class="w">            </span><span class="s1">&#39;http://localhost/config/listeners/*:443/tls/session/tickets/&#39;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>To add a new key on each server:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">NEWKEY</span><span class="o">=</span><span class="k">$(</span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">48</span><span class="k">)</span>

<span class="k">for</span><span class="w"> </span>SRV<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$SERVERS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ssh<span class="w"> </span><span class=nxt_hint title="Assuming Unit runs as root on each server">root</span>@<span class="nv">$SRV</span><span class="w">  </span><span class="se">\</span>
<span class="w">        </span>curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\&quot;$NEWKEY\&quot;&#39;</span><span class="w"> </span>--unix-socket<span class="w"> </span><span class=nxt_ph title="Path to the remote control socket">/path/to/control.unit.sock</span><span class="w">  </span><span class="se">\</span>
<span class="w">            </span><span class="s1">&#39;http://localhost/config/listeners/*:443/tls/session/tickets/&#39;</span><span class="s2">&quot;</span>
<span class="s2">done</span>
</pre></div>
</div>
<p>To delete the oldest key after adding the new one:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="w"> </span>SRV<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$SERVERS</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>ssh<span class="w"> </span><span class=nxt_hint title="Assuming Unit runs as root on each server">root</span>@<span class="nv">$SRV</span><span class="w">  </span><span class="se">\</span>
<span class="w">        </span>curl<span class="w"> </span>-X<span class="w"> </span>DELETE<span class="w"> </span>--unix-socket<span class="w"> </span><span class=nxt_ph title="Path to the remote control socket">/path/to/control.unit.sock</span><span class="w">  </span><span class="se">\</span>
<span class="w">            </span><span class="s1">&#39;http://localhost/config/listeners/*:443/tls/session/tickets/0&#39;</span>
<span class="k">done</span>
</pre></div>
</div>
<p>This scheme enables safely sharing session ticket keys
between individual Unit instances.</p>
</div>
</details><p>Unit supports AES256 (80-byte keys) or AES128 (48-byte keys);
the bytes should be encoded in Base64:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">48</span>

<span class="go">      LoYjFVxpUFFOj4TzGkr5MsSIRMjhuh8RCsVvtIJiQ12FGhn0nhvvQsEND1+OugQ7</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">80</span>

<span class="go">      GQczhdXawyhTrWrtOXI7l3YYUY98PrFYzjGhBbiQsAWgaxm+mbkm4MmZZpDw0tkK</span>
<span class="go">      YTqYWxofDtDC4VBznbBwTJTCgYkJXknJc4Gk2zqD1YA=</span>
</pre></div>
</div>
</li>
<li><p class="first">An array of strings just like the one above:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;<span class=nxt_hint title="Enables session tickets, sets two session ticket keys">tickets</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;IAMkP16P8OBuqsijSDGKTpmxrzfFNPP4EdRovXH2mqstXsodPC6MqIce5NlMzHLP&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;Ax4bv/JvMWoQG+BfH0feeM9Qb32wSaVVKOj1+1hmyU8ORMPHnf3Tio8gLkqm2ifC&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Unit uses these keys to decrypt the tickets submitted by clients
who want to recover their session state;
the last key is always used to create new session tickets
and update the tickets created earlier.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">An empty array effectively disables session tickets,
same as setting <strong>tickets</strong> to <strong>false</strong>.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="ip-protocol-forwarding">
<span id="configuration-listeners-forwarded"></span><h3>IP, protocol forwarding<a class="headerlink" href="#ip-protocol-forwarding" title="Permalink to this heading">§</a></h3>
<p>Unit enables the <strong>X-Forwarded-*</strong> header fields
with the <strong>forwarded</strong> object and its options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>source</strong> (required)</td>
<td><p class="first">String or an array of strings;
defines
<a class="reference internal" href="#configuration-routes-matching-patterns"><span class="std std-ref">address-based patterns</span></a>
for trusted addresses.
Replacement occurs only if the source IP of the request is a
<a class="reference internal" href="#configuration-routes-matching-resolution"><span class="std std-ref">match</span></a>.</p>
<p class="last">A special case here is the <strong>“unix”</strong> string;
it matches <em>any</em> UNIX domain sockets.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>client_ip</strong></td>
<td>String;
names the HTTP header fields to expect in the request.
They should use the
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For">X-Forwarded-For</a>
format where the value is a comma- or space-separated list
of IPv4s or IPv6s.</td>
</tr>
<tr class="row-even"><td><strong>protocol</strong></td>
<td>String;
defines the relevant HTTP header field to look for in the request.
Unit expects it to follow the
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto">X-Forwarded-Proto</a>
notation,
with the field value itself
being <strong>http</strong>, <strong>https</strong>, or <strong>on</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>recursive</strong></td>
<td><p class="first">Boolean;
controls how the <strong>client_ip</strong> fields are traversed.</p>
<p class="last">The default is <strong>false</strong>
(no recursion).</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Besides <strong>source</strong>,
the <strong>forwarded</strong> object must specify
<strong>client_ip</strong>, <strong>protocol</strong>, or both.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Before version 1.28.0,
Unit provided the <strong>client_ip</strong> object
that evolved into <strong>forwarded</strong>:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>client_ip</strong> (pre-1.28.0)</th>
<th class="head"><strong>forwarded</strong> (post-1.28.0)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>header</strong></td>
<td><strong>client_ip</strong></td>
</tr>
<tr class="row-odd"><td><strong>recursive</strong></td>
<td><strong>recursive</strong></td>
</tr>
<tr class="row-even"><td><strong>source</strong></td>
<td><strong>source</strong></td>
</tr>
<tr class="row-odd"><td>N/A</td>
<td><strong>protocol</strong></td>
</tr>
</tbody>
</table>
<p class="last">This old syntax still works but will be eventually deprecated,
though not earlier than version 1.30.0.</p>
</div>
<p>When <strong>forwarded</strong> is set,
Unit respects the appropriate header fields
only if the immediate source IP of the request
<a class="reference internal" href="#configuration-routes-matching-resolution"><span class="std std-ref">matches</span></a>
the <strong>source</strong> option.
Mind that it can use not only subnets but any
<a class="reference internal" href="#configuration-routes-matching-patterns"><span class="std std-ref">address-based patterns</span></a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;forwarded&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;client_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;<span class=nxt_hint title="Ranges can be specified explicitly">198.51.100.1-198.51.100.254</span>&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;<span class=nxt_hint title="Negation rejects any addresses originating here">!198.51.100.128/26</span>&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;<span class=nxt_hint title="Individual addresses are supported as well">203.0.113.195</span>&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="overwriting-protocol-scheme">
<span id="configuration-listeners-xfp"></span><h4>Overwriting protocol scheme<a class="headerlink" href="#overwriting-protocol-scheme" title="Permalink to this heading">§</a></h4>
<p>The <strong>protocol</strong> option enables overwriting
the incoming request’s protocol scheme
based on the header field it specifies.
Consider the following <strong>forwarded</strong> configuration:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;forwarded&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X-Forwarded-Proto&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;192.0.2.0/24&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;198.51.100.0/24&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Suppose a request arrives with the following header field:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X-Forwarded-Proto: https
</pre></div>
</div>
<p>If the source IP of the request matches <strong>source</strong>,
Unit handles this request as an <strong>https</strong> one.</p>
</div>
<div class="section" id="originating-ip-identification">
<span id="configuration-listeners-xff"></span><h4>Originating IP identification<a class="headerlink" href="#originating-ip-identification" title="Permalink to this heading">§</a></h4>
<p>Unit also supports identifying the clients’ originating IPs
with the <strong>client_ip</strong> option:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;forwarded&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;client_ip&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;X-Forwarded-For&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;recursive&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;192.0.2.0/24&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;198.51.100.0/24&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Suppose a request arrives with the following header fields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X-Forwarded-For: 192.0.2.18
X-Forwarded-For: 203.0.113.195, 198.51.100.178
</pre></div>
</div>
<p>If <strong>recursive</strong> is set to <strong>false</strong>
(default),
Unit chooses the <em>rightmost</em> address of the <em>last</em> field
named in <strong>client_ip</strong>
as the originating IP of the request.
In the example,
it’s set to 198.51.100.178 for requests from 192.0.2.0/24 or 198.51.100.0/24.</p>
<p>If <strong>recursive</strong> is set to <strong>true</strong>,
Unit inspects all <strong>client_ip</strong> fields in reverse order.
Each is traversed from right to left
until the first non-trusted address;
if found, it’s chosen as the originating IP.
In the previous example with <strong>“recursive”: true</strong>,
the client IP would be set to 203.0.113.195
because 198.51.100.178 is also trusted;
this simplifies working behind multiple reverse proxies.</p>
</div>
</div>
</div>
<div class="section" id="routes">
<span id="configuration-routes"></span><h2>Routes<a class="headerlink" href="#routes" title="Permalink to this heading">§</a></h2>
<p>The <strong>config/routes</strong> configuration entity
defines internal request routing.
It receives requests
from <a class="reference internal" href="#configuration-listeners"><span class="std std-ref">listeners</span></a>
and filters them through
<a class="reference internal" href="#configuration-routes-matching"><span class="std std-ref">sets of conditions</span></a>
to be processed by
<a class="reference internal" href="#configuration-applications"><span class="std std-ref">apps</span></a>,
<a class="reference internal" href="#configuration-proxy"><span class="std std-ref">proxied</span></a>
to external servers or
<a class="reference internal" href="#configuration-upstreams"><span class="std std-ref">load-balanced</span></a>
between them,
served with
<a class="reference internal" href="#configuration-static"><span class="std std-ref">static content</span></a>,
<a class="reference internal" href="#configuration-return"><span class="std std-ref">answered</span></a>
with arbitrary status codes, or
<a class="reference internal" href="#configuration-return"><span class="std std-ref">redirected</span></a>.</p>
<p>In its simplest form,
<strong>routes</strong> is an array
that defines a single route:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;*:8300&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">},</span>

<span class="w">     </span><span class="nt">&quot;<span class=nxt_hint title="Array-mode routes, simply referred to as 'routes'">routes</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">         </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable route array may go here; see the 'Route Steps' section for details">...</span>&quot;</span>
<span class="w">     </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another form is an object
with one or more named route arrays as members:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;*:8300&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">             </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes/main&quot;</span>
<span class="w">         </span><span class="p">}</span>
<span class="w">     </span><span class="p">},</span>

<span class="w">     </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;<span class=nxt_hint title="Named route, referred to as 'routes/main'">main</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">             </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable route array may go here; see the 'Route Steps' section for details">...</span>&quot;</span>
<span class="w">         </span><span class="p">],</span>

<span class="w">         </span><span class="nt">&quot;<span class=nxt_hint title="Named route, referred to as 'routes/route66'">route66</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">             </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable route array may go here; see the 'Route Steps' section for details">...</span>&quot;</span>
<span class="w">         </span><span class="p">]</span>
<span class="w">     </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="route-steps">
<span id="configuration-routes-step"></span><h3>Route steps<a class="headerlink" href="#route-steps" title="Permalink to this heading">§</a></h3>
<p>A
<a class="reference internal" href="#configuration-routes"><span class="std std-ref">route</span></a>
array contains step objects as elements;
they accept the following options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>action</strong> (required)</td>
<td>Object;
defines how matching requests are
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">handled</span></a>.</td>
</tr>
<tr class="row-odd"><td><strong>match</strong></td>
<td>Object;
defines the step’s
<a class="reference internal" href="#configuration-routes-matching"><span class="std std-ref">conditions</span></a>
to be matched.</td>
</tr>
</tbody>
</table>
<p>A request passed to a route traverses its steps sequentially:</p>
<ul class="simple">
<li>If all <strong>match</strong> conditions in a step are met,
the traversal ends
and the step’s <strong>action</strong> is performed.</li>
<li>If a step’s condition isn’t met,
Unit proceeds to the next step of the route.</li>
<li>If no steps of the route match,
a 404 “Not Found” response is returned.</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If a step omits the <strong>match</strong> option,
its <strong>action</strong> occurs automatically.
Thus, use no more than one such step per route,
always placing it last to avoid potential routing issues.</p>
</div>
<details id=conf-route-examples_
            onclick="window.location.hash='#conf-route-examples'">
            <summary><span>Ad-Hoc examples</span></summary><div class="docutils container">
<p>A basic one:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;example.com&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;scheme&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/php/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php_version&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static_version<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This route passes all HTTPS requests
to the <strong>/php/</strong> subsection of the <strong>example.com</strong> website
to the <strong>php_version</strong> app.
All other requests are served with static content
from the <strong>/www/static_version/</strong> directory.
If there’s no matching content,
a 404 “Not Found” response is returned.</p>
<p>A more elaborate example with chained routes and proxying:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;main&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;scheme&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes/http_site&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog.example.com&quot;</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/blog&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                        </span><span class="s2">&quot;*.css&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span>
<span class="w">                        </span><span class="s2">&quot;*.js&quot;</span>
<span class="w">                    </span><span class="p">]</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;http_site&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/v2_site/*&quot;</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/v2_site&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://127.0.0.1:9000&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, a route called <strong>main</strong> is explicitly defined,
so <strong>routes</strong> is an object instead of an array.
The first step of the route passes all HTTP requests
to the <strong>http_site</strong> app.
The second step passes all requests
that target <strong>blog.example.com</strong>
to the <strong>blog</strong> app.
The final step serves requests for certain file types
from the <strong>/www/static/</strong> directory.
If no steps match,
a 404 “Not Found” response is returned.</p>
</div>
</details></div>
<div class="section" id="matching-conditions">
<span id="configuration-routes-matching"></span><h3>Matching conditions<a class="headerlink" href="#matching-conditions" title="Permalink to this heading">§</a></h3>
<p>Conditions in a
<a class="reference internal" href="#configuration-routes-step"><span class="std std-ref">route step</span></a>’s
<strong>match</strong> object
define patterns to be compared to the request’s properties:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Property</th>
<th class="head">Patterns Are Matched Against</th>
<th class="head">Case‑<span class=nxt_hint title="For arguments, cookies, and headers, this relates to property names and values; for other properties, case sensitivity affects only values">
                         Sensitive</span></th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>arguments</strong></td>
<td>Arguments supplied with the request’s
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">query string</a>;
these names and value pairs are
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent decoded</a>,
with plus signs
(<strong>+</strong>)
replaced by spaces.</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><strong>cookies</strong></td>
<td>Cookies supplied with the request.</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td><strong>destination</strong></td>
<td>Target IP address and optional port of the request.</td>
<td>No</td>
</tr>
<tr class="row-odd"><td><strong>headers</strong></td>
<td><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110#section-6.3">Header fields</a>
supplied with the request.</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>host</strong></td>
<td><strong>Host</strong>
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110#section-7.2">header field</a>,
converted to lower case and normalized
by removing the port number and the trailing period
(if any).</td>
<td>No</td>
</tr>
<tr class="row-odd"><td><strong>method</strong></td>
<td><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7231#section-4">Method</a>
from the request line,
uppercased.</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>query</strong></td>
<td><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">Query string</a>,
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent decoded</a>,
with plus signs
(<strong>+</strong>)
replaced by spaces.</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><strong>scheme</strong></td>
<td>URI
<a class="reference external" href="https://www.iana.org/assignments/uri-schemes/uri-schemes.xhtml">scheme</a>.
Accepts only two patterns,
either <strong>http</strong> or <strong>https</strong>.</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>source</strong></td>
<td>Source IP address and optional port of the request.</td>
<td>No</td>
</tr>
<tr class="row-odd"><td><strong>uri</strong></td>
<td><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110#target.resource">Request target</a>,
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent decoded</a>
and normalized
by removing the
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">query string</a>
and resolving
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-4.2">relative references</a>
(“.” and “..”, “//”).</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<details id=args-vs-query_
            onclick="window.location.hash='#args-vs-query'">
            <summary><span>Arguments vs. query</span></summary><div class="docutils container">
<p>Both <strong>arguments</strong> and <strong>query</strong> operate on the query string,
but <strong>query</strong> is matched against the entire string
whereas <strong>arguments</strong> considers only the key-value pairs
such as <strong>key1=4861&amp;key2=a4f3</strong>.</p>
<p>Use <strong>arguments</strong> to define conditions
based on key-value pairs in the query string:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;4861&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a4f3&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Argument order is irrelevant:
<strong>key1=4861&amp;key2=a4f3</strong> and <strong>key2=a4f3&amp;key1=4861</strong>
are considered the same.
Also, multiple occurrences of an argument must all match,
so <strong>key=4861&amp;key=a4f3</strong> matches this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;arguments&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But not this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;arguments&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a*&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To the contrary,
use <strong>query</strong>
if your conditions concern query strings
but don’t rely on key-value pairs:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;utf16&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This only matches query strings
of the form
<strong>https://example.com?utf8</strong> or <strong>https://example.com?utf16</strong>.</p>
</div>
</details><div class="section" id="match-resolution">
<span id="configuration-routes-matching-resolution"></span><h4>Match resolution<a class="headerlink" href="#match-resolution" title="Permalink to this heading">§</a></h4>
<p>To be a match,
the property must meet two requirements:</p>
<ul class="simple">
<li>If there are patterns without negation
(the <strong>!</strong> prefix),
at least one of them matches the property value.</li>
<li>No negated patterns match the property value.</li>
</ul>
<details id=pattern-set-theory_
            onclick="window.location.hash='#pattern-set-theory'">
            <summary><span>Formal explanation</span></summary><div class="docutils container">
<p>This logic can be described with set operations.
Suppose set <em>U</em> comprises all possible values of a property;
set <em>P</em> comprises strings that match any patterns without negation;
set <em>N</em> comprises strings that match any negation-based patterns.
In this scheme,
the matching set is:</p>
<div class="line-block">
<div class="line"><em>U</em> ∩ <em>P</em> \ <em>N</em> if <em>P</em> ≠ ∅</div>
<div class="line"><em>U</em> \ <em>N</em> if <em>P</em> = ∅</div>
</div>
</div>
</details><p>Here, the URI of the request must fit <strong>pattern3</strong>,
but must not match <strong>pattern1</strong> or <strong>pattern2</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;!pattern1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!pattern2&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;pattern3&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Additionally, special matching logic applies to
<strong>arguments</strong>, <strong>cookies</strong>, and <strong>headers</strong>.
Each of these can be either
a single object that lists custom-named properties and their patterns
or an array of such objects.</p>
<p>To match a single object,
the request must match <em>all</em> properties named in the object.
To match an object array,
it’s enough to match <em>any</em> single one of its item objects.
The following condition matches only
if the request arguments include <strong>arg1</strong> and <strong>arg2</strong>,
and both match their patterns:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;arg1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;arg2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With an object array,
the condition matches
if the request’s arguments include
<strong>arg1</strong> or <strong>arg2</strong>
(or both)
that matches the respective pattern:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;arg1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;arg2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following example combines all matching types.
Here, <strong>host</strong>, <strong>method</strong>, <strong>uri</strong>,
<strong>arg1</strong> <em>and</em> <strong>arg2</strong>,
either <strong>cookie1</strong> or <strong>cookie2</strong>,
and either <strong>header1</strong> or <strong>header2</strong> <em>and</em> <strong>header3</strong>
must be matched
for the <strong>action</strong> to be taken
(<strong>host &amp; method &amp; uri &amp; arg1 &amp; arg2 &amp; (cookie1 | cookie2)
&amp; (header1 | (header2 &amp; header3))</strong>):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;!pattern&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!pattern&quot;</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;arg1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;arg2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;!pattern&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;cookies&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;cookie1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;cookie2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;header1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;header2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;header3&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pattern&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<details id=conf-obj-pattern-examples_
            onclick="window.location.hash='#conf-obj-pattern-examples'">
            <summary><span>Object pattern examples</span></summary><div class="docutils container">
<p>This requires <strong>mode=strict</strong>
and any <strong>access</strong> argument other than <strong>access=full</strong>
in the URI query:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;mode&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;!full&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This matches requests that
either use <strong>gzip</strong> and identify as <strong>Mozilla/5.0</strong>
or list <strong>curl</strong> as the user agent:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;Accept-Encoding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*gzip*&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;User-Agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Mozilla/5.0*&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;User-Agent&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;curl*&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details></div>
<div class="section" id="pattern-syntax">
<span id="configuration-routes-matching-patterns"></span><h4>Pattern syntax<a class="headerlink" href="#pattern-syntax" title="Permalink to this heading">§</a></h4>
<p>Individual patterns can be
address-based
(<strong>source</strong> and <strong>destination</strong>)
or string-based
(other properties).</p>
<p>String-based patterns must match the property to a character;
wildcards or
<span class=nxt_hint title="Available only if Unit was built with PCRE support enabled, which is the default for the official packages">
                         regexes</span>
modify this behavior:</p>
<ul class="simple">
<li>A wildcard pattern may contain any combination of wildcards
(<strong>*</strong>),
each standing for an arbitrary number of characters:
<strong>How*s*that*to*you</strong>.</li>
</ul>
<ul class="simple" id="configuration-routes-matching-patterns-regex">
<li>A regex pattern starts with a tilde
(<strong>~</strong>):
<strong>~^\d+\.\d+\.\d+\.\d+</strong>
(escaping backslashes is a
<a class="reference external" href="https://www.json.org/json-en.html">JSON requirement</a>).
The regexes are
<a class="reference external" href="https://www.pcre.org/current/doc/html/pcre2syntax.html">PCRE</a>-flavored.</li>
</ul>
<details id=percent-encoding_
            onclick="window.location.hash='#percent-encoding'">
            <summary><span>Percent encoding in arguments, query, and URI patterns</span></summary><div class="docutils container">
<p>Argument names, non-regex string patterns in <strong>arguments</strong>,
<strong>query</strong>, and <strong>uri</strong> can be
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent encoded</a>
to mask special characters
(<strong>!</strong> is <strong>%21</strong>, <strong>~</strong> is <strong>%7E</strong>,
<strong>*</strong> is <strong>%2A</strong>, <strong>%</strong> is <strong>%25</strong>)
or even target single bytes.
For example, you can select diacritics such as Ö or Å
by their starting byte <strong>0xC3</strong> in UTF-8:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;word&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*%C3*&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Unit decodes such strings
and matches them against respective request entities,
decoding these as well:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Tilde">%7E</span>fuzzy word search&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This condition matches the following percent-encoded request:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://127.0.0.1/?~fuzzy<span class=nxt_ph title="Space">%20</span>word<span class=nxt_ph title="Space">%20</span>search<span class="w"> </span>-v

<span class="go">      &gt; GET /?~fuzzy%20word%20search HTTP/1.1</span>
<span class="go">      ...</span>
<span class="go">      &lt; HTTP/1.1 200 OK</span>
<span class="go">      ...</span>
</pre></div>
</div>
<p>Note that the encoded spaces
(<strong>%20</strong>)
in the request
match their unencoded counterparts in the pattern;
vice versa, the encoded tilde
(<strong>%7E</strong>)
in the condition matches <strong>~</strong> in the request.</p>
</div>
</details><details id=conf-str-pattern-examples_
            onclick="window.location.hash='#conf-str-pattern-examples'">
            <summary><span>String pattern examples</span></summary><div class="docutils container">
<p>A regular expression that matches any <strong>.php</strong> files
in the <strong>/data/www/</strong> directory and its subdirectories.
Note the backslashes;
escaping is a JSON-specific requirement:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~^/data/www/.*\\.php(/.*)?$&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Only subdomains of <strong>example.com</strong> match:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*.example.com&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Only requests for <strong>.php</strong> files
located in <strong>/admin/</strong>’s subdirectories
match:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/admin/*/*.php&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, any <strong>eu-</strong> subdomains of <strong>example.com</strong> match
except <strong>eu-5.example.com</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;eu-*.example.com&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!eu-5.example.com&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Any methods match
except <strong>HEAD</strong> and <strong>GET</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;!HEAD&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!GET&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can also combine certain special characters in a pattern.
Here, any URIs match
except the ones containing <strong>/api/</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;!*/api/*&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, URIs of any articles
that don’t look like <strong>YYYY-MM-DD</strong> dates
match.
Again, note the backslashes;
they are a JSON requirement:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;/articles/*&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!~/articles/\\d{4}-\\d{2}-\\d{2}&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details><p>Address-based patterns define individual IPv4
(dot-decimal or
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc4632">CIDR</a>),
IPv6 (hexadecimal or
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc4291#section-2.3">CIDR</a>),
or any
<a class="reference external" href="https://en.wikipedia.org/wiki/Unix_domain_socket">UNIX domain socket</a>
addresses
that must exactly match the property;
wildcards and ranges modify this behavior:</p>
<ul class="simple">
<li>Wildcards
(<strong>*</strong>)
can only match arbitrary IPs
(<strong>*:&lt;port&gt;</strong>).</li>
<li>Ranges
(<strong>-</strong>)
work with both IPs
(in respective notation)
and ports
(<strong>&lt;start_port&gt;-&lt;end_port&gt;</strong>).</li>
</ul>
<details id=allow-deny_
            onclick="window.location.hash='#allow-deny'">
            <summary><span>Address-based allow-deny lists</span></summary><div class="docutils container">
<p>Addresses come in handy
when implementing an allow-deny mechanism
with routes,
for instance:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;!192.168.1.1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;!10.1.1.0/16&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;192.168.1.0/24&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;2001:0db8::/32&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>See
<a class="reference internal" href="#configuration-routes-matching-resolution"><span class="std std-ref">here</span></a>
for details of pattern resolution order;
this corresponds to the following <strong class="program">nginx</strong> directive:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kn">deny</span><span class="w">  </span><span class="mi">10</span><span class="s">.1.1.0/16</span><span class="p">;</span>
<span class="w">    </span><span class="kn">deny</span><span class="w">  </span><span class="mi">192</span><span class="s">.168.1.1</span><span class="p">;</span>
<span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="mi">192</span><span class="s">.168.1.0/24</span><span class="p">;</span>
<span class="w">    </span><span class="kn">allow</span><span class="w"> </span><span class="n">2001</span><span class="p">:</span><span class="mi">0</span><span class="s">db8::/32</span><span class="p">;</span>
<span class="w">    </span><span class="kn">deny</span><span class="w">  </span><span class="s">all</span><span class="p">;</span>

<span class="w">    </span><span class="kn">root</span><span class="w"> </span><span class="s">/www/data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details><details id=conf-addr-pattern-examples_
            onclick="window.location.hash='#conf-addr-pattern-examples'">
            <summary><span>Address pattern examples</span></summary><div class="docutils container">
<p>This uses IPv4-based matching with wildcards and ranges:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;192.0.2.1-192.0.2.200&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;198.51.100.1-198.51.100.200:8000&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;203.0.113.1-203.0.113.200:8080-8090&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*:80&quot;</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;destination&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;192.0.2.0/24&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;198.51.100.0/24:8000&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;203.0.113.0/24:8080-8090&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*:80&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This uses IPv6-based matching with wildcards and ranges:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">             </span><span class="s2">&quot;2001:0db8::-2001:0db8:aaa9:ffff:ffff:ffff:ffff:ffff&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;[2001:0db8:aaaa::-2001:0db8:bbbb::]:8000&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;[2001:0db8:bbbb::1-2001:0db8:cccc::]:8080-8090&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;*:80&quot;</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;destination&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">             </span><span class="s2">&quot;2001:0db8:cccd::/48&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;[2001:0db8:ccce::/48]:8000&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;[2001:0db8:ccce:ffff::/64]:8080-8090&quot;</span><span class="p">,</span>
<span class="w">             </span><span class="s2">&quot;*:80&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This matches any of the listed IPv4 or IPv6 addresses:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;destination&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;192.168.0.1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;::1&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;2001:0db8:1::c0a8:1&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, any IPs from the range match
except <strong>192.0.2.9</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;192.0.2.1-192.0.2.10&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;!192.0.2.9&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This matches any IPs but limits the acceptable ports:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;*:80&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*:443&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*:8000-8080&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This matches any UNIX domain sockets:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;unix&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Any acceptable 'pass' value may go here; see the 'Listeners' section for details">...</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details></div>
</div>
<div class="section" id="handling-actions">
<span id="configuration-routes-action"></span><h3>Handling actions<a class="headerlink" href="#handling-actions" title="Permalink to this heading">§</a></h3>
<p>If a request matches all
<a class="reference internal" href="#configuration-routes-matching"><span class="std std-ref">conditions</span></a>
of a route step
or the step itself omits the <strong>match</strong> object,
Unit handles the request with the respective <strong>action</strong>.
The mutually exclusive <strong>action</strong> types are:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>pass</strong></td>
<td>Destination for the request,
identical to a listener’s <strong>pass</strong> option.</td>
<td><a class="reference internal" href="#configuration-listeners"><span class="std std-ref">Listeners</span></a></td>
</tr>
<tr class="row-odd"><td><strong>proxy</strong></td>
<td>Socket address of an HTTP server
to where the request is proxied.</td>
<td><a class="reference internal" href="#configuration-proxy"><span class="std std-ref">Proxying</span></a></td>
</tr>
<tr class="row-even"><td><strong>return</strong></td>
<td>HTTP status code
with a context-dependent redirect location.</td>
<td><a class="reference internal" href="#configuration-return"><span class="std std-ref">Instant responses, redirects</span></a></td>
</tr>
<tr class="row-odd"><td><strong>share</strong></td>
<td>File paths that serve the request with static content.</td>
<td><a class="reference internal" href="#configuration-static"><span class="std std-ref">Static files</span></a></td>
</tr>
</tbody>
</table>
<p>An additional option is applicable to any of these actions:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
<th class="head">Details</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>response_headers</strong></td>
<td>Updates the header fields
of the upcoming response.</td>
<td><a class="reference internal" href="#configuration-response-headers"><span class="std std-ref">Response headers</span></a></td>
</tr>
<tr class="row-odd"><td><strong>rewrite</strong></td>
<td>Updated the request URI,
preserving the query string.</td>
<td><a class="reference internal" href="#configuration-rewrite"><span class="std std-ref">URI rewrite</span></a></td>
</tr>
</tbody>
</table>
<p>An example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;/v1/*&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;/v2/*&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;rewrite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app/<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/app&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;~\\.jpe?g$&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;/var/www/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;/var/www/static/assets<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">                 </span><span class="p">],</span>

<span class="w">                </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                     </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;upstreams/cdn&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/proxy/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://192.168.0.100:80&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/return/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">301</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://www.example.com&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="variables">
<span id="configuration-variables-native"></span><span id="configuration-variables"></span><h2>Variables<a class="headerlink" href="#variables" title="Permalink to this heading">§</a></h2>
<p>Some options in Unit configuration
allow the use of
<a class="reference internal" href="#configuration-variables-native"><span class="std std-ref">variables</span></a>
whose values are calculated at runtime.
There’s a number of built-in variables available:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Variable</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>arg_*</strong>, <strong>cookie_*</strong>, <strong>header_*</strong></td>
<td>Variables that store
<a class="reference internal" href="#configuration-routes-matching"><span class="std std-ref">request arguments, cookies, and header fields</span></a>,
such as <strong>arg_queryTimeout</strong>,
<strong>cookie_sessionId</strong>,
or <strong>header_Accept_Encoding</strong>.
The names of the <strong>header_*</strong> variables are case insensitive.</td>
</tr>
<tr class="row-odd"><td><strong>body_bytes_sent</strong></td>
<td>Number of bytes sent in the response body.</td>
</tr>
<tr class="row-even"><td><strong>dollar</strong></td>
<td>Literal dollar sign (<strong>$</strong>),
used for escaping.</td>
</tr>
<tr class="row-odd"><td><strong>header_referer</strong></td>
<td>Contents of the <strong>Referer</strong> request
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referer">header field</a>.</td>
</tr>
<tr class="row-even"><td><strong>header_user_agent</strong></td>
<td>Contents of the <strong>User-Agent</strong> request
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent">header field</a>.</td>
</tr>
<tr class="row-odd"><td><strong>host</strong></td>
<td><strong>Host</strong>
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110#section-7.2">header field</a>,
converted to lower case and normalized
by removing the port number
and the trailing period (if any).</td>
</tr>
<tr class="row-even"><td><strong>method</strong></td>
<td><a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7231#section-4">Method</a>
from the request line.</td>
</tr>
<tr class="row-odd"><td><strong>remote_addr</strong></td>
<td>Remote IP address of the request.</td>
</tr>
<tr class="row-even"><td><strong>request_id</strong></td>
<td>Contains a string generated with random data. Can be used as a unique
request identifier.</td>
</tr>
<tr class="row-odd"><td><strong>request_line</strong></td>
<td>Entire
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9112#section-3">request line</a>.</td>
</tr>
<tr class="row-even"><td><strong>request_time</strong></td>
<td>Request processing time in milliseconds,
formatted as follows:
<strong>1.234</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>request_uri</strong></td>
<td>Request target
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.3">path</a>
<em>including</em> the
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">query</a>,
normalized by resolving relative path references
(“.” and “..”)
and collapsing adjacent slashes.</td>
</tr>
<tr class="row-even"><td><strong>response_header_*</strong></td>
<td>Variables that store
<a class="reference internal" href="#configuration-response-headers"><span class="std std-ref">response header fields</span></a>,
such as <strong>response_header_content_type</strong>.
The names of these variables are case insensitive.</td>
</tr>
<tr class="row-odd"><td><strong>status</strong></td>
<td>HTTP
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7231#section-6">status code</a>
of the response.</td>
</tr>
<tr class="row-even"><td><strong>time_local</strong></td>
<td>Local time,
formatted as follows:
<strong>31/Dec/1986:19:40:00 +0300</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>uri</strong></td>
<td>Request target
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.3">path</a>
<em>without</em> the <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">query</a>
part,
normalized by resolving relative path references
(“.” and “..”)
and collapsing adjacent slashes.
The value is
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-2.1">percent decoded</a>:
Unit interpolates all percent-encoded entities
in the request target
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.3">path</a>.</td>
</tr>
</tbody>
</table>
<p>These variables can be used with:</p>
<ul class="simple">
<li><strong>pass</strong> in
<a class="reference internal" href="#configuration-listeners"><span class="std std-ref">listeners</span></a>
and
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
to choose between routes, applications, app targets, or upstreams.</li>
<li><strong>rewrite</strong> in
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
to enable <a class="reference internal" href="#configuration-rewrite"><span class="std std-ref">URI rewriting</span></a>.</li>
<li><strong>share</strong> and <strong>chroot</strong> in
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
to control
<a class="reference internal" href="#configuration-static"><span class="std std-ref">static content serving</span></a>.</li>
<li><strong>location</strong> in <strong>return</strong>
<a class="reference internal" href="#configuration-return"><span class="std std-ref">actions</span></a>
to enable HTTP redirects.</li>
<li><strong>format</strong> in the
<a class="reference internal" href="#configuration-access-log"><span class="std std-ref">access log</span></a>
to customize Unit’s log output.</li>
</ul>
<p>To reference a variable,
prefix its name with the dollar sign character
(<strong>$</strong>),
optionally enclosing the name in curly brackets
(<strong>{}</strong>)
to separate it from adjacent text
or enhance visibility.
Variable names can contain letters and underscores
(<strong>_</strong>),
so use the brackets
if the variable is immediately followed by such characters:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes/<span class=nxt_hint title="The method variable is thus separated from the '_route' postfix"><span class=nxt_var>${method}</span></span>_route&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;GET_route&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">201</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;PUT_route&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">202</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;POST_route&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">203</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To reference an <strong>arg_*</strong>,
<strong>cookie_*</strong>,
or <strong>header_*</strong> variable,
add the name you need to the prefix.
A query string of <strong>Type=car&amp;Color=red</strong>
yields two variables,
<strong>$arg_Type</strong> and <strong>$arg_Color</strong>;
Unit additionally normalizes capitalization and hyphenation
in header field names,
so the <strong>Accept-Encoding</strong> header field
can also be referred to as <strong>$header_Accept_Encoding</strong>,
<strong>$header_accept-encoding</strong>,
or <strong>$header_accept_encoding</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">With multiple argument instances
(think <strong>Color=Red&amp;Color=Blue</strong>),
the rightmost one is used (<strong>Blue</strong>).</p>
</div>
<p>At runtime,
variables expand into dynamically computed values
(at your risk!).
The previous example targets an entire set of routes,
picking individual ones by HTTP verbs
from the incoming requests:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-i<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>http://localhost

<span class="go">    HTTP/1.1 201 Created</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-i<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>http://localhost

<span class="go">    HTTP/1.1 202 Accepted</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-i<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost

<span class="go">    HTTP/1.1 203 Non-Authoritative Information</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>-i<span class="w"> </span>--head<span class="w"> </span>http://localhost<span class="w">  </span><span class="c1"># Bumpy ride ahead, no route defined</span>

<span class="go">    HTTP/1.1 404 Not Found</span>
</pre></div>
</div>
<p>If you reference a non-existing variable,
it is considered empty.</p>
<details id=variables-examples_
            onclick="window.location.hash='#variables-examples'">
            <summary><span>Examples</span></summary><div class="docutils container">
<p>This configuration selects the static file location
based on the requested hostname;
if nothing’s found,
it attempts to retrieve the requested file
from a common storage:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span><span class=nxt_hint title="Note that the $uri variable value always includes a starting slash"><span class=nxt_var>$uri</span></span>&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;/www/storage<span class=nxt_hint title="Note that the $uri variable value always includes a starting slash"><span class=nxt_var>$uri</span></span>&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another use case is employing the URI
to choose between applications:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications<span class=nxt_hint title="Note that the $uri variable value always includes a starting slash"><span class=nxt_var>$uri</span></span>&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;blog&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/blog_app/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.php&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;sandbox&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/sandbox_app/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.php&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way, requests are routed between applications by their target URIs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/blog<span class="w">     </span><span class="c1"># Targets the &#39;blog&#39; app</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/sandbox<span class="w">  </span><span class="c1"># Targets the &#39;sandbox&#39; app</span>
</pre></div>
</div>
<p>A different approach puts the <strong>Host</strong> header field
received from the client
to the same use:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/<span class=nxt_var>$host</span>&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;localhost&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/admin_section/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.php&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;www.example.com&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/path/to/public_app/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.php&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can use multiple variables in a string,
repeating and placing them arbitrarily.
This configuration picks an app target
(supported for
<a class="reference internal" href="#configuration-php-targets"><span class="std std-ref">PHP</span></a>
and
<a class="reference internal" href="#configuration-python-targets"><span class="std std-ref">Python</span></a>
apps)
based on the requested hostname and URI:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/app_<span class=nxt_var>$host</span><span class=nxt_hint title="Note that the $uri value doesn't include the request's query part"><span class=nxt_var>$uri</span></span>&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At runtime,
a request for <strong>example.com/myapp</strong>
is passed to <strong>applications/app_example.com/myapp</strong>.</p>
<p>To select a share directory
based on an <strong>app_session</strong> cookie:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/data/www/<span class=nxt_var>$cookie_app_session</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, if <strong>$uri</strong> in <strong>share</strong> resolves to a directory,
the choice of an index file to be served
is dictated by <strong>index</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data<span class=nxt_hint title="Note that the $uri variable value always includes a starting slash"><span class=nxt_var>$uri</span></span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;index&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.htm&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, a redirect uses the <strong>$request_uri</strong> variable value
to relay the request,
<em>including</em> the query part,
to the same website over HTTPS:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">301</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://<span class=nxt_var>$host</span><span class=nxt_var>$request_uri</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details></div>
<div class="section" id="uri-rewrite">
<span id="configuration-rewrite"></span><h2>URI rewrite<a class="headerlink" href="#uri-rewrite" title="Permalink to this heading">§</a></h2>
<p>All route step
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
support the <strong>rewrite</strong> option
that updates the URI of the incoming request
before the action is applied.
It does not affect the
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc3986#section-3.4">query</a>
but changes the
<strong>uri</strong> and
<strong>$request_uri</strong>
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variables</span></a>.</p>
<p>This <strong>match</strong>-less action
prefixes the request URI with <strong>/v1</strong>
and returns it to routing:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;rewrite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/v1<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Avoid infinite loops
when you  <strong>pass</strong> requests
back to <strong>routes</strong>.</p>
</div>
<p>This action
normalizes the request URI
and passes it to an application:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;/fancyAppA&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;/fancyAppB&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;rewrite&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/commonBackend&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/backend&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="response-headers">
<span id="configuration-response-headers"></span><h2>Response headers<a class="headerlink" href="#response-headers" title="Permalink to this heading">§</a></h2>
<p>All route step
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
support the <strong>response_headers</strong> option
that updates the header fields of Unit’s response
before the action is taken:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static/<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;response_headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Cache-Control&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;max-age=60, s-maxage=120&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;CDN-Cache-Control&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;max-age=600&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This works only for the <strong>2XX</strong> and <strong>3XX</strong> responses;
also, <strong>Date</strong>, <strong>Server</strong>, and <strong>Content-Length</strong> can’t be set.</p>
<p>The option sets given string values
for the header fields of the response
that Unit will send for the specific request:</p>
<ul class="simple">
<li>If there’s no header field associated with the name
(regardless of the case),
the value is set.</li>
<li>If a header field with this name is already set, its value is updated.</li>
<li>If <strong>null</strong> is supplied for the value, the header field is <em>deleted</em>.</li>
</ul>
<p>If the action is taken and Unit issues a response,
it sends the header fields <em>this specific</em> action specifies.
Only the last action
along the entire routing path of a request
affects the resulting response headers.</p>
<p>The values support
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variables</span></a>
and
<a class="reference internal" href="../scripting/"><span class="doc">template literals</span></a>,
which enables arbitrary runtime logic:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;response_headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Content-Language&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class="sb">`</span><span class="si">${</span><span class="w"> </span><span class="nx">uri</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s1">&#39;/uk&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;en-GB&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;en-US&#39;</span><span class="w"> </span><span class="si">}</span><span class="sb">`</span>&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, there are the <strong>response_header_*</strong> variables
that evaluate to the header field values set with the response
(by the app, upstream, or Unit itself;
the latter is the case with
<strong>$response_header_connection</strong>,
<strong>$response_header_content_length</strong>,
and <strong>$response_header_transfer_encoding</strong>).</p>
<p>One use is to update the headers in the final response;
this extends the <strong>Content-Type</strong> issued by the app:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/converter&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;response_headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;Content-Type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_var>${response_header_content_type}</span>;charset=iso-8859-1&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Alternatively, they will come in handy with
<a class="reference internal" href="#configuration-access-log"><span class="std std-ref">custom log formatting</span></a>.</p>
</div>
<div class="section" id="instant-responses-redirects">
<span id="configuration-return"></span><h2>Instant responses, redirects<a class="headerlink" href="#instant-responses-redirects" title="Permalink to this heading">§</a></h2>
<p>You can use route step
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">actions</span></a>
to instantly handle certain conditions
with arbitrary
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7231#section-6">HTTP status codes</a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/admin_console/*&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <strong>return</strong> action provides the following options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>return</strong> (required)</td>
<td>Integer (000–999);
defines the HTTP response status code
to be returned.</td>
</tr>
<tr class="row-even"><td><strong>location</strong></td>
<td>String URI;
used if the <strong>return</strong> value implies redirection.</td>
</tr>
</tbody>
</table>
<p>Use the codes according to their intended
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7231#section-6">semantics</a>;
if you use custom codes,
make sure that user agents can understand them.</p>
<p>If you specify a redirect code (3xx),
supply the destination
using the <strong>location</strong> option
alongside <strong>return</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">301</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;location&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;https://www.example.com&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Besides enriching the response semantics,
<strong>return</strong> simplifies <a class="reference internal" href="#allow-deny"><span class="std std-ref">allow-deny lists</span></a>:
instead of guarding each action with a filter,
add
<a class="reference internal" href="#configuration-routes-matching"><span class="std std-ref">conditions</span></a>
to deny unwanted requests as early as possible,
for example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;scheme&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;!192.168.1.1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;!10.1.1.0/16&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;192.168.1.0/24&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;2001:0db8::/32&quot;</span>
<span class="w">            </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;return&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="static-files">
<span id="configuration-static"></span><h2>Static files<a class="headerlink" href="#static-files" title="Permalink to this heading">§</a></h2>
<p>Unit is capable of acting as a standalone web server,
efficiently serving static files
from the local file system;
to use the feature,
list the file paths
in the <strong>share</strong> option
of a route step
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">action</span></a>.</p>
<p>A <strong>share</strong>-based action provides the following options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>share</strong> (required)</td>
<td><p class="first">String or an array of strings;
lists file paths that are tried
until a file is found.
When no file is found,
<strong>fallback</strong> is used if set.</p>
<p class="last">The value is
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variable</span></a>-interpolated.</p>
</td>
</tr>
<tr class="row-even"><td><strong>index</strong></td>
<td><p class="first">Filename;
tried if <strong>share</strong> is a directory.
When no file is found,
<strong>fallback</strong> is used if set.</p>
<p class="last">The default is <strong>index.html</strong>.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>fallback</strong></td>
<td>Action-like <a class="reference internal" href="#configuration-fallback"><span class="std std-ref">object</span></a>;
used if the request
can’t be served by <strong>share</strong> or <strong>index</strong>.</td>
</tr>
<tr class="row-even"><td><strong>types</strong></td>
<td><a class="reference internal" href="#configuration-share-mime"><span class="std std-ref">Array</span></a>
of
<a class="reference external" href="https://www.iana.org/assignments/media-types/media-types.xhtml">MIME type</a>
patterns;
used to filter the shared files.</td>
</tr>
<tr class="row-odd"><td><strong>chroot</strong></td>
<td><p class="first">Directory pathname that
<a class="reference internal" href="#configuration-share-path"><span class="std std-ref">restricts</span></a>
the shareable paths.</p>
<p class="last">The value is
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variable</span></a>-interpolated.</p>
</td>
</tr>
<tr class="row-even"><td><strong>follow_symlinks</strong>, <strong>traverse_mounts</strong></td>
<td><p class="first">Booleans;
turn on and off symbolic link and mount point
<a class="reference internal" href="#configuration-share-resolution"><span class="std std-ref">resolution</span></a>
respectively;
if <strong>chroot</strong> is set,
they only
<a class="reference internal" href="#configuration-share-path"><span class="std std-ref">affect</span></a>
the insides of <strong>chroot</strong>.</p>
<p class="last">The default for both options is <strong>true</strong>
(resolve links and mounts).</p>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To serve the files,
Unit’s router process must be able to access them;
thus, the account this process runs as
must have proper permissions
<a class="reference internal" href="../howto/security/#security-apps"><span class="std std-ref">assigned</span></a>.
When Unit is installed from the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">official packages</span></a>,
the process runs as <strong>unit:unit</strong>;
for details of other installation methods,
see <a class="reference internal" href="../installation/"><span class="doc">Installation</span></a>.</p>
</div>
<p>Consider the following configuration:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">     </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static/<span class=nxt_var>$uri</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It uses
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variable interpolation</span></a>:
Unit replaces the <strong>$uri</strong> reference
with its current value
and tries the resulting path.
If this doesn’t yield a servable file,
a 404 “Not Found” response is returned.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Before version 1.26.0,
Unit used <strong>share</strong> as the document root.
This was changed for flexibility,
so now <strong>share</strong> must resolve to specific files.
A common solution is
to append <strong>$uri</strong> to your document root.</p>
<p>Pre-1.26,
the snippet above would’ve looked like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static/&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="last">Mind that URI paths always start with a slash,
so there’s no need to separate the directory
from <strong>$uri</strong>;
even if you do, Unit compacts adjacent slashes
during path resolution,
so there won’t be an issue.</p>
</div>
<p>If <strong>share</strong> is an array,
its items are searched in order of appearance
until a servable file is found:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span><span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;/www/error_pages/not_found.html&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>This snippet tries a <strong>$host</strong>-based directory first;
if a suitable file isn’t found there,
the <strong>not_found.html</strong> file is tried.
If neither is accessible,
a 404 “Not Found” response is returned.</p>
<p>Finally, if a file path points to a directory,
Unit attempts to serve an <strong>index</strong>-indicated file from it.
Suppose we have the following directory structure
and share configuration:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/www/static/
├── ...
└──default.html
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;index&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default.html&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The following request returns <strong>default.html</strong>
even though the file isn’t named explicitly:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/<span class="w"> </span>-v

<span class="go"> ...</span>
<span class="go"> &lt; HTTP/1.1 200 OK</span>
<span class="go"> &lt; Last-Modified: Fri, 20 Sep 2021 04:14:43 GMT</span>
<span class="go"> &lt; ETag: &quot;5d66459d-d&quot;</span>
<span class="go"> &lt; Content-Type: text/html</span>
<span class="go"> &lt; Server: Unit/1.33.0</span>
<span class="go"> ...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unit’s ETag response header fields
use the <strong>MTIME-FILESIZE</strong> format,
where <strong>MTIME</strong> stands for file modification timestamp
and <strong>FILESIZE</strong> stands for file size in bytes,
both in hexadecimal.</p>
</div>
<div class="section" id="mime-filtering">
<span id="configuration-share-mime"></span><h3>MIME filtering<a class="headerlink" href="#mime-filtering" title="Permalink to this heading">§</a></h3>
<p>To filter the files a <strong>share</strong> serves
by their
<a class="reference external" href="https://www.iana.org/assignments/media-types/media-types.xhtml">MIME types</a>,
define a <strong>types</strong> array of string patterns.
They work like
<a class="reference internal" href="#configuration-routes-matching-patterns"><span class="std std-ref">route patterns</span></a>
but are compared to the MIME type of each file;
the request is served only if it’s a
<a class="reference internal" href="#configuration-routes-matching-resolution"><span class="std std-ref">match</span></a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;!text/javascript&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;!text/css&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;text/*&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;~video/3gpp2?&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This sample configuration blocks JS and CSS files with
<a class="reference internal" href="#configuration-routes-matching-resolution"><span class="std std-ref">negation</span></a>
but allows all other text-based MIME types with a
<a class="reference internal" href="#configuration-routes-matching-patterns"><span class="std std-ref">wildcard pattern</span></a>.
Additionally, the <strong>.3gpp</strong> and <strong>.3gpp2</strong> file types
are allowed by a
<a class="reference internal" href="#configuration-routes-matching-patterns"><span class="std std-ref">regex pattern</span></a>.</p>
<p>If no MIME types match the request, a 403 “Forbidden” response is
returned. You can pair that behavior with a
<a class="reference internal" href="#configuration-fallback"><span class="std std-ref">fallback</span></a> option that will be called
when a 40x response would be returned.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;image/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;font/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;text/*&quot;</span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;response_headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;Cache-Control&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;max-age=1209600&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, all requests to images, fonts, and any text-based files will have
a cache control header added to the response. Any other requests will still
serve the files, but this time without the header. This is useful
for serving common web page resources that do not change; web browsers
and proxies are informed that this content should be cached.</p>
<p>If the MIME type of a requested file isn’t recognized,
it’s considered empty
(<strong>“”</strong>).
Thus, the <strong>“!”</strong> pattern
(“deny empty strings”)
can be used to restrict all file types
<a class="reference internal" href="#configuration-mime"><span class="std std-ref">unknown</span></a>
to Unit:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/known-types-only<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;!&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If a share path specifies only the directory name,
Unit <em>doesn’t</em> apply MIME filtering.</p>
</div>
<div class="section" id="path-restrictions">
<span id="configuration-share-path"></span><h3>Path restrictions<a class="headerlink" href="#path-restrictions" title="Permalink to this heading">§</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To have these options,
Unit must be built and run
on a system with Linux kernel version 5.6+.</p>
</div>
<p>The <strong>chroot</strong> option confines the path resolution
within a share to a certain directory.
First, it affects symbolic links:
any attempts to go up the directory tree
with relative symlinks like <strong>../../var/log</strong>
stop at the <strong>chroot</strong> directory,
and absolute symlinks are treated as relative
to this directory to avoid breaking out:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Now, any paths accessible via the share are confined to this directory">/www/data/</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, a request for <strong>/log</strong>
initially resolves to <strong>/www/data/log</strong>;
however, if that’s an absolute symlink to <strong>/var/log/app.log</strong>,
the resulting path is <strong>/www/data/var/log/app.log</strong>.</p>
<p>Another effect is that any requests
for paths that resolve outside the <strong>chroot</strong> directory
are forbidden:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Now, any paths accessible via the share are confined to this directory">/www/data/</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, a request for <strong>/index.xml</strong>
elicits a 403 “Forbidden” response
because it resolves to <strong>/www/index.xml</strong>,
which is outside <strong>chroot</strong>.</p>
<p id="configuration-share-resolution">The <strong>follow_symlinks</strong> and <strong>traverse_mounts</strong> options
disable resolution of symlinks and traversal of mount points
when set to <strong>false</strong>
(both default to <strong>true</strong>):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;follow_symlinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc"><span class=nxt_hint title="Disables symlink traversal">false</span></span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;traverse_mounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc"><span class=nxt_hint title="Disables mount point traversal">false</span></span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, any symlink or mount point in the entire <strong>share</strong> path
results in a 403 “Forbidden” response.</p>
<p>With <strong>chroot</strong> set,
<strong>follow_symlinks</strong> and <strong>traverse_mounts</strong>
only affect portions of the path <em>after</em> <strong>chroot</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;follow_symlinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;traverse_mounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here, <strong>www/</strong> and interpolated <strong>$host</strong>
can be symlinks or mount points,
but any symlinks and mount points beyond them,
including the <strong>static/</strong> portion,
won’t be resolved.</p>
<details id=chroot-details_
            onclick="window.location.hash='#chroot-details'">
            <summary><span>Details</span></summary><div class="docutils container">
<p>Suppose you want to serve files from a share
that itself includes a symlink
(let’s assume <strong>$host</strong> always resolves to <strong>localhost</strong>
and make it a symlink in our example)
but disable any symlinks inside the share.</p>
<p>Initial configuration:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Now, any paths accessible via the share are confined to this directory">/www/<span class=nxt_var>$host</span>/</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Create a symlink to <strong>/www/localhost/static/index.html</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/www/localhost/static/<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span>/www/localhost/static/
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>cat<span class="w"> </span>&gt;<span class="w"> </span>index.html<span class="w"> </span>&lt;&lt;<span class="w"> </span>EOF

<span class="go">      &gt; index.html</span>
<span class="go">      &gt; EOF</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ln<span class="w"> </span>-s<span class="w"> </span>index.html<span class="w"> </span>/www/localhost/static/symlink
</pre></div>
</div>
<p>If symlink resolution is enabled
(with or without <strong>chroot</strong>),
a request that targets the symlink works:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/index.html

<span class="go">      index.html</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/symlink

<span class="go">      index.html</span>
</pre></div>
</div>
<p>Now set <strong>follow_symlinks</strong> to <strong>false</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Now, any paths accessible via the share are confined to this directory">/www/<span class=nxt_var>$host</span>/</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;follow_symlinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The symlink request is forbidden,
which is presumably the desired effect:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/index.html

<span class="go">      index.html</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/symlink

<span class="go">      &lt;!DOCTYPE html&gt;&lt;title&gt;Error 403&lt;/title&gt;&lt;p&gt;Error 403.</span>
</pre></div>
</div>
<p>Lastly, what difference does <strong>chroot</strong> make?
To see, remove it:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/<span class=nxt_var>$host</span>/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;follow_symlinks&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, <strong>“follow_symlinks”: false</strong> affects the entire share,
and <strong>localhost</strong> is a symlink,
so it’s forbidden:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>curl<span class="w"> </span>http://localhost/index.html

<span class="go">      &lt;!DOCTYPE html&gt;&lt;title&gt;Error 403&lt;/title&gt;&lt;p&gt;Error 403.</span>
</pre></div>
</div>
</div>
</details></div>
<div class="section" id="fallback-action">
<span id="configuration-fallback"></span><h3>Fallback action<a class="headerlink" href="#fallback-action" title="Permalink to this heading">§</a></h3>
<p>Finally, within an <strong>action</strong>,
you can supply a <strong>fallback</strong> option
beside a <strong>share</strong>.
It specifies the
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">action</span></a>
to be taken
if the requested file can’t be served
from the <strong>share</strong> path:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Serving a file can be impossible for different reasons, such as:</p>
<ul class="simple">
<li>The request’s HTTP method isn’t <strong>GET</strong> or <strong>HEAD</strong>.</li>
<li>The file’s MIME type doesn’t match the <strong>types</strong>
<a class="reference internal" href="#configuration-share-mime"><span class="std std-ref">array</span></a>.</li>
<li>The file isn’t found at the <strong>share</strong> path.</li>
<li>The router process has
<a class="reference internal" href="../howto/security/#security-apps"><span class="std std-ref">insufficient permissions</span></a>
to access the file or an underlying directory.</li>
</ul>
<p>In the previous example,
an attempt to serve the requested file
from the <strong>/www/data/static/</strong> directory
is made first.
Only if the file can’t be served,
the request is passed to the <strong>php</strong> application.</p>
<p>If the <strong>fallback</strong> itself is a <strong>share</strong>,
it can also contain a nested <strong>fallback</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/data/static<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/cache<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;chroot&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://127.0.0.1:9000&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first <strong>share</strong> tries to serve the request
from <strong>/www/data/static/</strong>;
on failure, the second <strong>share</strong> tries the <strong>/www/cache/</strong> path
with <strong>chroot</strong> enabled.
If both attempts fail,
the request is proxied elsewhere.</p>
<details id=conf-variable-examples_
            onclick="window.location.hash='#conf-variable-examples'">
            <summary><span>Examples</span></summary><div class="docutils container">
<p>One common use case that this feature enables
is the separation of requests
for static and dynamic content
into independent routes.
The following example relays all requests
that target <strong>.php</strong> files
to an application
and uses a catch-all static <strong>share</strong>
with a <strong>fallback</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;*.php&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php-app&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/assets/files<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://127.0.0.1:9000&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;php-app&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/scripts/&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can reverse this scheme for apps
that avoid filenames in dynamic URIs,
listing all types of static content
to be served from a <strong>share</strong>
in a <strong>match</strong> condition
and adding an unconditional application path:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                    </span><span class="s2">&quot;*.css&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;*.ico&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;*.js&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;*.png&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="s2">&quot;*.xml&quot;</span>
<span class="w">                </span><span class="p">]</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/assets/files<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://127.0.0.1:9000&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php-app&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;php-app&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/scripts/&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If image files should be served locally
and other proxied,
use the <strong>types</strong> array
in the first route step:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;*.css&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*.ico&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*.jpg&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*.js&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*.png&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;*.xml&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/assets/files<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;image/*&quot;</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://127.0.0.1:9000&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another way to combine
<strong>share</strong>, <strong>types</strong>, and <strong>fallback</strong>
is exemplified by the following compact pattern:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;share&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/php-app/assets/files<span class=nxt_var>$uri</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;!application/x-httpd-php&quot;</span>
<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;fallback&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php-app&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It forwards explicit requests for PHP files
to the app
while serving all other types of files
from the share;
note that a <strong>match</strong> object
isn’t needed here to achieve this effect.</p>
</div>
</details></div>
</div>
<div class="section" id="proxying">
<span id="configuration-proxy"></span><h2>Proxying<a class="headerlink" href="#proxying" title="Permalink to this heading">§</a></h2>
<p>Unit’s routes support HTTP proxying
to socket addresses
using the <strong>proxy</strong> option
of a route step
<a class="reference internal" href="#configuration-routes-action"><span class="std std-ref">action</span></a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/ipv4/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Note that the http:// scheme is required">http://127.0.0.1:8080</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/ipv6/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Note that the http:// scheme is required">http://[::1]:8080</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/unix/*&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;proxy&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Note that the http:// scheme is required, followed by the unix: prefix">http://unix:/path/to/unix.sock</span>&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the example suggests,
you can use UNIX, IPv4, and IPv6 socket addresses
for proxy destinations.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The HTTPS scheme is not supported yet.</p>
</div>
<div class="section" id="load-balancing">
<span id="configuration-upstreams"></span><h3>Load balancing<a class="headerlink" href="#load-balancing" title="Permalink to this heading">§</a></h3>
<p>Besides proxying requests to individual servers,
Unit can also relay incoming requests to <em>upstreams</em>.
An upstream is a group of servers
that comprise a single logical entity
and may be used as a <strong>pass</strong> destination
for incoming requests in a
<a class="reference internal" href="#configuration-listeners"><span class="std std-ref">listener</span></a>
or a
<a class="reference internal" href="#configuration-routes"><span class="std std-ref">route</span></a>.</p>
<p>Upstreams are defined
in the eponymous <strong>/config/upstreams</strong> section of the API:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;*:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;upstreams/rr-lb&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;upstreams&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;<span class=nxt_hint title="Upstream object">rr-lb</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;<span class=nxt_hint title="Lists individual servers as object-valued options">servers</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;<span class=nxt_hint title="Empty object needed due to JSON requirements">192.168.0.100:8080</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">                </span><span class="nt">&quot;192.168.0.101:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;weight&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>An upstream must define a <strong>servers</strong> object
that lists socket addresses
as server object names.
Unit dispatches requests between the upstream’s servers
in a round-robin fashion,
acting as a load balancer.
Each server object can set a numeric <strong>weight</strong>
to adjust the share of requests
it receives via the upstream.
In the above example,
<strong>192.168.0.100:8080</strong> receives twice as many requests
as <strong>192.168.0.101:8080</strong>.</p>
<p>Weights can be specified as integers or fractions
in decimal or scientific notation:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;servers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;192.168.0.100:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;<span class=nxt_hint title="All three values are equal">weight</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">1e1</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;192.168.0.101:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;<span class=nxt_hint title="All three values are equal">weight</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">10.0</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;192.168.0.102:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;<span class=nxt_hint title="All three values are equal">weight</span>&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The maximum weight is <strong>1000000</strong>,
the minimum is <strong>0</strong>
(such servers receive no requests);
the default is <strong>1</strong>.</p>
</div>
</div>
<div class="section" id="applications">
<span id="configuration-applications"></span><h2>Applications<a class="headerlink" href="#applications" title="Permalink to this heading">§</a></h2>
<p>Each app that Unit runs
is defined as an object
in the <strong>/config/applications</strong> section of the control API;
it lists the app’s language and settings,
its runtime limits,
process model,
and various language-specific options.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Our official
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">language-specific packages</span></a>
include end-to-end examples of application configuration,
available for your reference at
<strong>/usr/share/doc/&lt;module name&gt;/examples/</strong>
after package installation.</p>
</div>
<p>Here, Unit runs 20 processes of a PHP app called <strong>blogs</strong>,
stored in the <strong>/www/blogs/scripts/</strong> directory:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;blogs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/blogs/scripts/&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="configuration-apps-common">App objects have a number of options
shared between all application languages:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>type</strong> (required)</td>
<td><p class="first">Application type:
<strong>external</strong>
(Go and Node.js),
<strong>java</strong>,
<strong>perl</strong>,
<strong>php</strong>,
<strong>python</strong>,
<strong>ruby</strong>,
or <strong>wasm</strong>
(WebAssembly).</p>
<p>Except for <strong>external</strong> and <strong>wasm</strong>,
you can detail the runtime version:
<strong>“type”: “python 3”</strong>,
<strong>“type”: “python 3.4”</strong>,
or even
<strong>“type”: “python 3.4.9rc1”</strong>.
Unit searches its modules
and uses the latest matching one,
reporting an error if none match.</p>
<p class="last">For example, if you have only one PHP module,
7.1.9,
it matches <strong>“php”</strong>,
<strong>“php 7”</strong>,
<strong>“php 7.1”</strong>,
and <strong>“php 7.1.9”</strong>.
If you have modules for versions 7.0.2 and 7.0.23,
set <strong>“type”: “php 7.0.2”</strong> to specify the former;
otherwise, PHP&nbsp;7.0.23 will be used.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>environment</strong></td>
<td>String-valued object;
environment variables to be passed to the app.</td>
</tr>
<tr class="row-even"><td><strong>group</strong></td>
<td><p class="first">String;
group name that runs the
<a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>.</p>
<p class="last">The default is the <strong>user</strong>’s primary group.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>isolation</strong></td>
<td>Object; manages the isolation
of an application process.
For details, see
<a class="reference internal" href="#configuration-proc-mgmt-isolation"><span class="std std-ref">here</span></a>.</td>
</tr>
<tr class="row-even"><td><strong>limits</strong></td>
<td>Object; accepts two integer options,
<strong>timeout</strong> and <strong>requests</strong>.
Their values govern the life cycle of an application process.
For details, see
<a class="reference internal" href="#configuration-proc-mgmt-lmts"><span class="std std-ref">here</span></a>.</td>
</tr>
<tr class="row-odd"><td><strong>processes</strong></td>
<td><p class="first">Integer or object;
integer sets a static number of app processes,
and object options <strong>max</strong>,
<strong>spare</strong>,
and <strong>idle_timeout</strong>
enable dynamic management.
For details, see
<a class="reference internal" href="#configuration-proc-mgmt-prcs"><span class="std std-ref">here</span></a>.</p>
<p class="last">The default is 1.</p>
</td>
</tr>
<tr class="row-even"><td><strong>stderr</strong>, <strong>stdout</strong></td>
<td><p class="first">Strings;
filenames where Unit redirects the application’s output.</p>
<p>The default when running <em>with</em> <strong>--no-daemon</strong> is to send
<em>stdout</em> to the <em>console</em> and <em>stderr</em> to Unit’s <em>log</em>.</p>
<p>The default when running <em>without</em> <strong>--no-daemon</strong> is to send
<em>stdout</em> to <em>/dev/null</em> and <em>stderr</em> to Unit’s <em>log</em>.</p>
<p class="last">These options have <em>no</em> effect when running with <strong>--no-daemon</strong>.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>user</strong></td>
<td><p class="first">String;
username that runs the
<a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>.</p>
<p class="last">The default is the username configured at
<a class="reference internal" href="../howto/source/#source-config-src"><span class="std std-ref">build time</span></a>
or at
<a class="reference internal" href="../howto/source/#source-startup"><span class="std std-ref">startup</span></a>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>working_directory</strong></td>
<td><p class="first">String;
the app’s working directory.</p>
<p class="last">The default is
the working directory
of Unit’s
<a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">main process</span></a>.</p>
</td>
</tr>
</tbody>
</table>
<p>Also, you need to set <strong>type</strong>-specific options
to run the app.
This
<a class="reference internal" href="#configuration-python"><span class="std std-ref">Python app</span></a>
sets <strong>path</strong> and <strong>module</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python 3.6&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/python-apps&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog.wsgi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;environment&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;DJANGO_SETTINGS_MODULE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog.settings.prod&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;DB_ENGINE&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;django.db.backends.postgresql&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;DB_NAME&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;DB_HOST&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;DB_PORT&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;5432&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="process-management">
<span id="configuration-proc-mgmt"></span><h3>Process management<a class="headerlink" href="#process-management" title="Permalink to this heading">§</a></h3>
<p>Unit has three per-app options
that control how the app’s processes behave:
<strong>isolation</strong>, <strong>limits</strong>, and <strong>processes</strong>.
Also, you can <strong>GET</strong>
the <strong>/control/applications/</strong> section of the API
to restart an app:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span>--unix-socket<span class="w"> </span><span class=nxt_ph title="Path to Unit's control socket in your installation">/path/to/control.unit.sock</span><span class="w">  </span><span class="se">\</span>
<span class="w">      </span>http://localhost/control/applications/<span class=nxt_ph title="Your application's name as defined in the /config/applications/ section">app_name</span>/restart
</pre></div>
</div>
<p>Unit handles the rollover gracefully,
allowing the old processes
to deal with existing requests
and starting a new set of processes
(as defined by the <strong>processes</strong>
<a class="reference internal" href="#configuration-proc-mgmt-prcs"><span class="std std-ref">option</span></a>)
to accept new requests.</p>
<div class="section" id="process-isolation">
<span id="configuration-proc-mgmt-isolation"></span><h4>Process isolation<a class="headerlink" href="#process-isolation" title="Permalink to this heading">§</a></h4>
<p>You can use
<a class="reference external" href="https://man7.org/linux/man-pages/man7/namespaces.7.html">namespace</a>
and
<a class="reference external" href="https://man7.org/linux/man-pages/man2/chroot.2.html">file system</a>
isolation for your apps
if Unit’s underlying OS supports them:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls<span class="w"> </span>/proc/self/ns/

<span class="go">    cgroup <span class=nxt_hint title="The mount namespace">mnt</span> <span class=nxt_hint title="The network namespace">net</span> pid ... <span class=nxt_hint title="The credential namespace">user</span> <span class=nxt_hint title="The uname namespace">uts</span></span>
</pre></div>
</div>
<p>The <strong>isolation</strong> application option
has the following members:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>automount</strong></td>
<td><p class="first">Object;
controls mount behavior
if <strong>rootfs</strong> is enabled.
By default, Unit automatically mounts the
<a class="reference internal" href="#conf-rootfs"><span class="std std-ref">language runtime dependencies</span></a>,
a
<a class="reference external" href="https://man7.org/linux/man-pages/man5/procfs.5.html">procfs</a>
at <strong>/proc/</strong>,
and a
<a class="reference external" href="https://man7.org/linux/man-pages/man5/tmpfs.5.html">tmpfs</a> at <strong>/tmp/</strong>,
but you can disable any of these default mounts:</p>
<div class="last highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;automount&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;language_deps&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;procfs&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;tmpfs&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><strong>cgroup</strong></td>
<td><p class="first">Object;
defines the app’s
<a class="reference internal" href="#conf-app-cgroup"><span class="std std-ref">cgroup</span></a>.</p>
<table border="1" class="last docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>path</strong> (required)</td>
<td>String;
configures absolute or relative path of the app
in the
<a class="reference external" href="https://man7.org/linux/man-pages/man7/cgroups.7.html#CGROUPS_VERSION_2">cgroups v2 hierarchy</a>.
The limits trickle down the hierarchy,
so child cgroups can’t exceed parental thresholds.</td>
</tr>
</tbody>
</table>
</td>
</tr>
<tr class="row-even"><td><strong>gidmap</strong></td>
<td>Same as <strong>uidmap</strong>,
but configures group IDs instead of user IDs.</td>
</tr>
<tr class="row-odd"><td><strong>namespaces</strong></td>
<td><p class="first">Object; configures
<a class="reference external" href="https://man7.org/linux/man-pages/man7/namespaces.7.html">namespace</a>
isolation scheme for the application.</p>
<p>Available options
(system-dependent;
check your OS manual for guidance):</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>cgroup</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/cgroup_namespaces.7.html">cgroup</a>
namespace for the app.</td>
</tr>
<tr class="row-even"><td><strong>credential</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html">user</a>
namespace for the app.</td>
</tr>
<tr class="row-odd"><td><strong>mount</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html">mount</a>
namespace for the app.</td>
</tr>
<tr class="row-even"><td><strong>network</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/network_namespaces.7.html">network</a>
namespace for the app.</td>
</tr>
<tr class="row-odd"><td><strong>pid</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/pid_namespaces.7.html">PID</a>
namespace for the app.</td>
</tr>
<tr class="row-even"><td><strong>uname</strong></td>
<td>Creates a new
<a class="reference external" href="https://man7.org/linux/man-pages/man7/namespaces.7.html">UTS</a>
namespace for the app.</td>
</tr>
</tbody>
</table>
<p class="last">All options listed above are Boolean;
to isolate the app,
set the corresponding namespace option to <strong>true</strong>;
to disable isolation,
set the option to <strong>false</strong>
(default).</p>
</td>
</tr>
<tr class="row-even"><td><strong>rootfs</strong></td>
<td>String; pathname of the directory
to be used as the new
<a class="reference internal" href="#conf-rootfs"><span class="std std-ref">file system root</span></a>
for the app.</td>
</tr>
<tr class="row-odd"><td><strong>uidmap</strong></td>
<td><p class="first">Array of user ID
<a class="reference internal" href="#conf-uidgid-mapping"><span class="std std-ref">mapping objects</span></a>;
each array item must define the following:</p>
<table border="1" class="last docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>container</strong></td>
<td>Integer;
starts the user ID mapping range
in the app’s namespace.</td>
</tr>
<tr class="row-even"><td><strong>host</strong></td>
<td>Integer;
starts the user ID mapping range
in the OS namespace.</td>
</tr>
<tr class="row-odd"><td><strong>size</strong></td>
<td>Integer;
size of the ID range
in both namespaces.</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p>A sample <strong>isolation</strong> object
that enables all namespaces
and sets mappings for user and group IDs:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;namespaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;cgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;credential&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;mount&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;network&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;pid&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;uname&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;cgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/unit/appcgroup&quot;</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;uidmap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;gidmap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="using-control-groups">
<span id="conf-app-cgroup"></span><h5>Using control groups<a class="headerlink" href="#using-control-groups" title="Permalink to this heading">§</a></h5>
<p>A control group (cgroup) commands
the use of computational resources
by a group of processes
in a unified hierarchy.
Cgroups are defined
by their <em>paths</em>
in the cgroups file system.</p>
<p>The <strong>cgroup</strong> object
defines the cgroup
for a Unit app;
its <strong>path</strong> option
can set an absolute
(starting with <strong>/</strong>)
or a relative value.
If the path doesn’t exist
in the cgroups file system,
Unit creates it.</p>
<p>Relative paths are implicitly placed
inside the cgroup of Unit’s
<a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">main process</span></a>;
this setting effectively puts the app
to the <strong>/&lt;main Unit process cgroup&gt;/production/app</strong> cgroup:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;cgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;production/app&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>An absolute pathname places the application
under a separate cgroup subtree;
this configuration puts the app under <strong>/staging/app</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;cgroup&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/staging/app&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A basic use case
would be to set a memory limit on a cgroup.
First,
find the cgroup mount point:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>mount<span class="w"> </span>-l<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>cgroup

<span class="go">    cgroup2 on /sys/fs/cgroup type cgroup2 (rw,nosuid,nodev,noexec,relatime,nsdelegate,memory_recursiveprot)</span>
</pre></div>
</div>
<p>Next, check the available controllers
and set the <strong>memory.high</strong> limit:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>cat<span class="w"> </span>/sys/fs/cgroup/<span class=nxt_hint title="cgroup's path set in Unit configuration">/staging/app</span>/cgroup.controllers

<span class="go">    cpuset cpu io memory pids</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span><span class="nb">echo</span><span class="w"> </span>1G<span class="w"> </span>&gt;<span class="w"> </span>/sys/fs/cgroup<span class=nxt_hint title="cgroup's path set in Unit configuration">/staging/app</span>/memory.high
</pre></div>
</div>
<p>For more details
and possible options,
refer to the
<a class="reference external" href="https://docs.kernel.org/admin-guide/cgroup-v2.html">admin guide</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To avoid confusion,
mind that the <strong>namespaces/cgroups</strong> option
controls the application’s cgroup <em>namespace</em>;
instead, the <strong>cgroup/path</strong> option
specifies the cgroup where Unit puts the application.</p>
</div>
</div>
<div class="section" id="changing-root-directory">
<span id="conf-rootfs"></span><h5>Changing root directory<a class="headerlink" href="#changing-root-directory" title="Permalink to this heading">§</a></h5>
<p>The <strong>rootfs</strong> option confines the app
to the directory you provide,
making it the new
<a class="reference external" href="https://man7.org/linux/man-pages/man2/chroot.2.html">file system root</a>.
To use it,
your app should have the corresponding privilege
(effectively,
run as <strong>root</strong> in most cases).</p>
<p>The root directory is changed
before the language module starts the app,
so any path options for the app
should be relative to the new root.
Note the <strong>path</strong> and <strong>home</strong> settings:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python 2.7&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Without rootfs, this would be /var/app/sandbox/">/</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;home&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Without rootfs, this would be /var/app/sandbox/venv/">/venv/</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;wsgi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;rootfs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/app/sandbox/&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>When using <strong>rootfs</strong>
with <strong>credential</strong> set to <strong>true</strong>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;rootfs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/app/sandbox/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;namespaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;credential&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="last">Ensure that the user the app <em>runs as</em>
can access the <strong>rootfs</strong> directory.</p>
</div>
<p>Unit mounts language-specific files and directories
to the new root
so the app stays operational:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Language</th>
<th class="head">Language-Specific Mounts</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Java</td>
<td><ul class="first last simple">
<li>JVM’s <strong>libc.so</strong> directory</li>
<li>Java module’s
<a class="reference internal" href="../howto/source/#modules-java"><span class="std std-ref">home</span></a>
directory</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Python</td>
<td>Python’s <strong>sys.path</strong>
<a class="reference external" href="https://docs.python.org/3/library/sys.html#sys.path">directories</a></td>
</tr>
<tr class="row-even"><td>Ruby</td>
<td><ul class="first last simple">
<li>Ruby’s header, interpreter, and library
<a class="reference external" href="https://idiosyncratic-ruby.com/42-ruby-config.html">directories</a>:
<strong>rubyarchhdrdir</strong>,
<strong>rubyhdrdir</strong>,
<strong>rubylibdir</strong>,
<strong>rubylibprefix</strong>,
<strong>sitedir</strong>,
and <strong>topdir</strong></li>
<li>Ruby’s gem installation directory
(<strong>gem env gemdir</strong>)</li>
<li>Ruby’s entire gem path list
(<strong>gem env gempath</strong>)</li>
</ul>
</td>
</tr>
</tbody>
</table>
<details id=conf-uidgid-mapping_
            onclick="window.location.hash='#conf-uidgid-mapping'">
            <summary><span>Using "uidmap", "gidmap"</span></summary><div class="docutils container">
<p>The <strong>uidmap</strong> and <strong>gidmap</strong> options
are available only
if the underlying OS supports
<a class="reference external" href="https://man7.org/linux/man-pages/man7/user_namespaces.7.html">user namespaces</a>.</p>
<p>If <strong>uidmap</strong> is omitted but <strong>credential</strong> isolation is enabled,
the effective UID (EUID) of the application process
in the host namespace
is mapped to the same UID
in the container namespace;
the same applies to <strong>gidmap</strong> and GID, respectively.
This means that the configuration below:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;some_user&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;namespaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;credential&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Is equivalent to the following
(assuming <strong>some_user</strong>’s EUID and EGID are both equal to 1000):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;some_user&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;isolation&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;namespaces&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;credential&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;uidmap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>

<span class="w">        </span><span class="nt">&quot;gidmap&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;host&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;container&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1000&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</details></div>
</div>
<div class="section" id="request-limits">
<span id="configuration-proc-mgmt-lmts"></span><h4>Request limits<a class="headerlink" href="#request-limits" title="Permalink to this heading">§</a></h4>
<p>The <strong>limits</strong> object
controls request handling by the app process
and has two integer options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>requests</strong></td>
<td>Integer;
maximum number of requests
an app process can serve.
When the limit is reached,
the process restarts;
this mitigates possible memory leaks
or other cumulative issues.</td>
</tr>
<tr class="row-odd"><td><strong>timeout</strong></td>
<td><p class="first">Integer;
request timeout in seconds.
If an app process exceeds it
while handling a request,
Unit cancels the request
and returns a 503 “Service Unavailable” response
to the client.</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Now, Unit doesn’t detect freezes,
so the hanging process stays on
the app’s process pool.</p>
</div>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/python-apps&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;blog.wsgi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;limits&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;requests&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="application-processes">
<span id="configuration-proc-mgmt-prcs"></span><h4>Application processes<a class="headerlink" href="#application-processes" title="Permalink to this heading">§</a></h4>
<p>The <strong>processes</strong> option
offers a choice
between static and dynamic process management.
If you set it to an integer,
Unit immediately launches the given number of app processes
and keeps them without scaling.</p>
<p>To enable a dynamic prefork model for your app,
supply a <strong>processes</strong> object with the following options:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>idle_timeout</strong></td>
<td>Number of seconds
Unit waits for
before terminating an idle process
that exceeds <strong>spare</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>max</strong></td>
<td><p class="first">Maximum number of application processes
that Unit maintains
(busy and idle).</p>
<p class="last">The default is 1.</p>
</td>
</tr>
<tr class="row-even"><td><strong>spare</strong></td>
<td>Minimum number of idle processes
that Unit tries to maintain for an app.
When the app is started,
<strong>spare</strong> idles are launched;
Unit passes new requests to existing idles,
forking new idles
to keep the <strong>spare</strong> level
if <strong>max</strong> allows.
When busy processes complete their work
and turn idle again,
Unit terminates extra idles
after <strong>idle_timeout</strong>.</td>
</tr>
</tbody>
</table>
<p>If <strong>processes</strong> is omitted entirely,
Unit creates 1 static process.
If an empty object is provided: <strong>“processes”: {}</strong>,
dynamic behavior
with default option values
is assumed.</p>
<p>Here, Unit allows 10 processes maximum,
keeps 5 idles,
and terminates extra idles after 20 seconds:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;max&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;spare&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;idle_timeout&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For details of manual application process restart, see
<a class="reference internal" href="#configuration-proc-mgmt"><span class="std std-ref">here</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="go">
<span id="configuration-go"></span><span id="configuration-languages"></span><h3>Go<a class="headerlink" href="#go" title="Permalink to this heading">§</a></h3>
<p>To run a Go app on Unit,
modify its source
to make it Unit-aware
and rebuild the app.</p>
<details id=updating-go-apps_
            onclick="window.location.hash='#updating-go-apps'">
            <summary><span>Updating Go apps to run on Unit</span></summary><div class="docutils container">
<p>Unit uses
<a class="reference external" href="https://pkg.go.dev/cmd/cgo">cgo</a>
to invoke C code from Go,
so check the following prerequisites:</p>
<ul>
<li><p class="first">The <span class="target" id="index-0"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">CGO_ENABLED</span></code> variable is set to <strong>1</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>go<span class="w"> </span>env<span class="w"> </span>CGO_ENABLED

<span class="go">      0</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>go<span class="w"> </span>env<span class="w"> </span>-w<span class="w"> </span><span class="nv">CGO_ENABLED</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</li>
<li><p class="first">If you installed Unit from the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">official packages</span></a>,
install the development package:</p>
<div class="nxt_tabs docutils container">
<input name=go-prereq type=radio
            id=go-prereq_0 class=nojs checked/>
            <label for=go-prereq_0 id=go-prereq-debianubuntu>
            <a href=#go-prereq-debianubuntu onclick="nxt_tab_click(event)">Debian, Ubuntu</a></label><div class="docutils container">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>apt<span class="w"> </span>install<span class="w"> </span>unit-dev
</pre></div>
</div>
</div>
<input name=go-prereq type=radio
            id=go-prereq_1 class=nojs />
            <label for=go-prereq_1 id=go-prereq-amazonfedorarhel>
            <a href=#go-prereq-amazonfedorarhel onclick="nxt_tab_click(event)">Amazon, Fedora, RHEL</a></label><div class="docutils container">
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>yum<span class="w"> </span>install<span class="w"> </span>unit-devel
</pre></div>
</div>
</div>
</div>
</li>
<li><p class="first">If you installed Unit from
<a class="reference internal" href="../howto/source/"><span class="doc">source</span></a>,
install the include files and libraries:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>make<span class="w"> </span>libunit-install
</pre></div>
</div>
</li>
</ul>
<p>In the <strong>import</strong> section,
list the <strong>unit.nginx.org/go</strong> package:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="s">&quot;unit.nginx.org/go&quot;</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Replace the <strong>http.ListenAndServe</strong> call
with <strong>unit.ListenAndServe</strong>:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handler</span><span class="p">)</span>
<span class="w">    </span><span class="o">...</span>
<span class="w">    </span><span class="c1">// http.ListenAndServe(&quot;:8080&quot;, nil)</span>
<span class="w">    </span><span class="nx">unit</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you haven’t done so yet,
initialize the Go module for your app:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>go<span class="w"> </span>mod<span class="w"> </span>init<span class="w"> </span><span class=nxt_ph title="Arbitrary module designation">example.com/app</span>

<span class="go">      go: creating new go.mod: module example.com/app</span>
</pre></div>
</div>
<p>Install the newly added dependency
and build your application:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>go<span class="w"> </span>get<span class="w"> </span>unit.nginx.org/go@1.33.0

<span class="go">      go: downloading unit.nginx.org</span>

<span class="gp">$ </span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span><span class=nxt_ph title="Executable name">app</span><span class="w"> </span><span class=nxt_ph title="Application source code">app.go</span>
</pre></div>
</div>
<p>If you update Unit to a newer version,
repeat the two commands above
to rebuild your app.</p>
<p>The resulting executable works as follows:</p>
<ul class="simple">
<li>When you run it standalone,
the <strong>unit.ListenAndServe</strong> call
falls back to <strong>http</strong> functionality.</li>
<li>When Unit runs it,
<strong>unit.ListenAndServe</strong> directly communicates
with Unit’s router process,
ignoring the address supplied as its first argument
and relying on the
<a class="reference internal" href="#configuration-listeners"><span class="std std-ref">listener’s settings</span></a>
instead.</li>
</ul>
</div>
</details><p>Next, configure the app on Unit;
besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>executable</strong> (required)</td>
<td>String;
pathname of the application,
absolute or relative to <strong>working_directory</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>arguments</strong></td>
<td>Array of strings;
command-line arguments
to be passed to the application.
The example below is equivalent to
<strong>/www/chat/bin/chat_app --tmp-files /tmp/go-cache</strong>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/chat&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;executable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;bin/chat_app&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-go&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-go&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;--tmp-files&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;/tmp/go-cache&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Go-based examples,
see our
<a class="reference internal" href="../howto/grafana/"><span class="doc">Grafana</span></a>
howto or a basic
<a class="reference internal" href="../howto/samples/#sample-go"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
<div class="section" id="java">
<span id="configuration-java"></span><h3>Java<a class="headerlink" href="#java" title="Permalink to this heading">§</a></h3>
<p>First, make sure to install Unit
along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">Java language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>webapp</strong> (required)</td>
<td>String;
pathname
of the application’s <strong>.war</strong> file
(packaged or unpackaged).</td>
</tr>
<tr class="row-odd"><td><strong>classpath</strong></td>
<td>Array of strings;
paths to your app’s required libraries
(may point to directories
or individual <strong>.jar</strong> files).</td>
</tr>
<tr class="row-even"><td><strong>options</strong></td>
<td><p class="first">Array of strings;
defines JVM runtime options.</p>
<p class="last">Unit itself
exposes the <strong>-Dnginx.unit.context.path</strong> option
that defaults to <strong>/</strong>;
use it to customize the
<a class="reference external" href="https://javaee.github.io/javaee-spec/javadocs/javax/servlet/ServletContext.html#getContextPath--">context path</a>.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>thread_stack_size</strong></td>
<td><p class="first">Integer;
stack size of a worker thread
(in bytes,
multiple of memory page size;
the minimum value is usually architecture specific).</p>
<p class="last">The default is usually system dependent
and can be set with <strong class="program">ulimit -s &lt;SIZE_KB&gt;</strong>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>threads</strong></td>
<td><p class="first">Integer;
number of worker threads
per <a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>.
When started,
each app process creates this number of threads
to handle requests.</p>
<p class="last">The default is <strong>1</strong>.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;java&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;classpath&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;/www/qwk2mart/lib/qwk2mart-2.0.0.jar&quot;</span>
<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;-Dlog_path=/var/log/qwk2mart.log&quot;</span>
<span class="w">    </span><span class="p">],</span>

<span class="w">    </span><span class="nt">&quot;webapp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/qwk2mart/qwk2mart.war&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Java-based examples,
see our
<a class="reference internal" href="../howto/jira/"><span class="doc">Jira</span></a>,
<a class="reference internal" href="../howto/opengrok/"><span class="doc">OpenGrok</span></a>,
and
<a class="reference internal" href="../howto/springboot/"><span class="doc">Spring Boot</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-java"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
<div class="section" id="node-js">
<span id="configuration-nodejs"></span><h3>Node.js<a class="headerlink" href="#node-js" title="Permalink to this heading">§</a></h3>
<p>First, you need to have the <strong class="program">unit-http</strong> module
<a class="reference internal" href="../installation/#installation-nodejs-package"><span class="std std-ref">installed</span></a>.
If it’s global,
symlink it in your project directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>npm<span class="w"> </span>link<span class="w"> </span>unit-http
</pre></div>
</div>
<p>Do the same if you move a Unit-hosted app
to a new system
where <strong class="program">unit-http</strong> is installed globally.
Also, if you update Unit later,
update the Node.js module as well
according to your
<a class="reference internal" href="../installation/#installation-nodejs-package"><span class="std std-ref">installation method</span></a>.</p>
<p>Next, to run your Node.js apps on Unit,
you need to configure them.
Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>executable</strong> (required)</td>
<td><p class="first">String;
pathname of the app,
absolute or relative to <strong>working_directory</strong>.</p>
<p>Supply your <strong>.js</strong> pathname here
and start the file itself
with a proper shebang:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env node</span>
</pre></div>
</div>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure to <strong class="command">chmod +x</strong>
the file you list here
so Unit can start it.</p>
</div>
</td>
</tr>
<tr class="row-odd"><td><strong>arguments</strong></td>
<td>Array of strings;
command-line arguments
to be passed to the app.
The example below is equivalent to
<strong>/www/apps/node-app/app.js --tmp-files /tmp/node-cache</strong>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/app/node-app/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;executable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app.js&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-node&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-node&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;--tmp-files&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;/tmp/node-cache&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p id="configuration-nodejs-loader">You can run Node.js apps without altering their code,
using a loader module
we provide with <strong class="program">unit-http</strong>.
Apply the following app configuration,
depending on your version of Node.js:</p>
<div class="nxt_tabs docutils container">
<input name=nodejs type=radio
            id=nodejs_0 class=nojs checked/>
            <label for=nodejs_0 id=nodejs-1416xandlater>
            <a href=#nodejs-1416xandlater onclick="nxt_tab_click(event)">14.16.x and later</a></label><div class="docutils container">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;executable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="The external app type allows to run arbitrary executables, provided they establish communication with Unit">/usr/bin/env</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;node&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;--loader&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;unit-http/loader.mjs&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;--require&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;unit-http/loader&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;<span class=nxt_ph title="Application script name">app.js</span>&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<input name=nodejs type=radio
            id=nodejs_1 class=nojs />
            <label for=nodejs_1 id=nodejs-1415xandearlier>
            <a href=#nodejs-1415xandearlier onclick="nxt_tab_click(event)">14.15.x and earlier</a></label><div class="docutils container">
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;external&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;executable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="The external app type allows to run arbitrary executables, provided they establish communication with Unit">/usr/bin/env</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;arguments&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;node&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;--require&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;unit-http/loader&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;<span class=nxt_ph title="Application script name">app.js</span>&quot;</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>The loader overrides the <strong>http</strong> and <strong>websocket</strong> modules
with their Unit-aware versions
and starts the app.</p>
<p>You can also run your Node.js apps without the loader
by updating the application source code.
For that, use <strong>unit-http</strong> instead of <strong>http</strong> in your code:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">http</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;unit-http&#39;</span><span class="p">);</span>
</pre></div>
</div>
<p>To use the WebSocket protocol,
your app only needs to replace the default <strong>websocket</strong>:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">webSocketServer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;unit-http/websocket&#39;</span><span class="p">).</span><span class="nx">server</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Node.js-based examples,
see our
<a class="reference internal" href="../howto/apollo/"><span class="doc">Apollo</span></a>,
<a class="reference internal" href="../howto/express/"><span class="doc">Express</span></a>,
<a class="reference internal" href="../howto/koa/"><span class="doc">Koa</span></a>,
and
<a class="reference internal" href="../howto/docker/#docker-apps"><span class="std std-ref">Docker</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-nodejs"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
<div class="section" id="perl">
<span id="configuration-perl"></span><h3>Perl<a class="headerlink" href="#perl" title="Permalink to this heading">§</a></h3>
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">Perl language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>script</strong> (required)</td>
<td>String;
PSGI script path.</td>
</tr>
<tr class="row-odd"><td><strong>thread_stack_size</strong></td>
<td><p class="first">Integer;
stack size of a worker thread
(in bytes,
multiple of memory page size;
the minimum value is usually architecture specific).</p>
<p class="last">The default is usually system dependent
and can be set with <strong class="program">ulimit -s &lt;SIZE_KB&gt;</strong>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>threads</strong></td>
<td><p class="first">Integer;
number of worker threads
per <a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>.
When started,
each app process creates this number of threads
to handle requests.</p>
<p class="last">The default is <strong>1</strong>.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;perl&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/bugtracker/app.psgi&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/bugtracker&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Perl-based examples of Perl,
see our
<a class="reference internal" href="../howto/bugzilla/"><span class="doc">Bugzilla</span></a>
and
<a class="reference internal" href="../howto/catalyst/"><span class="doc">Catalyst</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-perl"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
<div class="section" id="php">
<span id="configuration-php"></span><h3>PHP<a class="headerlink" href="#php" title="Permalink to this heading">§</a></h3>
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">PHP language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>, you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>root</strong> (required)</td>
<td>String;
base directory
of the app’s file structure.
All URI paths are relative to it.</td>
</tr>
<tr class="row-odd"><td><strong>index</strong></td>
<td><p class="first">String;
filename added to URI paths
that point to directories
if no <strong>script</strong> is set.</p>
<p class="last">The default is <strong>index.php</strong>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>options</strong></td>
<td>Object;
<a class="reference internal" href="#configuration-php-options"><span class="std std-ref">defines</span></a>
the <strong>php.ini</strong> location and options.</td>
</tr>
<tr class="row-odd"><td><strong>script</strong></td>
<td>String;
filename of a <strong>root</strong>-based PHP script
that serves all requests to the app.</td>
</tr>
<tr class="row-even"><td><strong>targets</strong></td>
<td>Object;
defines application sections with
<a class="reference internal" href="#configuration-php-targets"><span class="std std-ref">custom</span></a>
<strong>root</strong>, <strong>script</strong>, and <strong>index</strong> values.</td>
</tr>
</tbody>
</table>
<p>The <strong>index</strong> and <strong>script</strong> options
enable two modes of operation:</p>
<ul class="simple">
<li>If <strong>script</strong> is set,
all requests to the application are handled
by the script you specify in this option.</li>
<li>Otherwise, the requests are served
according to their URI paths;
if they point to directories,
<strong>index</strong> is used.</li>
</ul>
<p id="configuration-php-options">You can customize <strong>php.ini</strong>
via the <strong>options</strong> object:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>admin</strong>, <strong>user</strong></td>
<td><p class="first">Objects for extra directives.
Values in <strong>admin</strong> are set in <strong>PHP_INI_SYSTEM</strong> mode,
so the app can’t alter them;
<strong>user</strong> values are set in <strong>PHP_INI_USER</strong> mode
and can be
<a class="reference external" href="https://www.php.net/manual/en/function.ini-set.php">updated</a>
at runtime.</p>
<ul class="last simple">
<li>The objects override the settings
from any <strong>*.ini</strong> files</li>
<li>The <strong>admin</strong> object can only set what’s
<a class="reference external" href="https://www.php.net/manual/en/ini.list.php">listed</a>
as <strong>PHP_INI_SYSTEM</strong>;
for other modes,
set <strong>user</strong></li>
<li>Neither <strong>admin</strong> nor <strong>user</strong>
can set directives listed as
<a class="reference external" href="https://www.php.net/manual/en/ini.list.php">php.ini only</a>
except for <strong>disable_classes</strong> and <strong>disable_functions</strong></li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><strong>file</strong></td>
<td>String;
pathname of the <strong>php.ini</strong> file with
<a class="reference external" href="https://www.php.net/manual/en/ini.list.php">PHP configuration directives</a>.</td>
</tr>
</tbody>
</table>
<p>To load multiple <strong>.ini</strong> files,
use <strong>environment</strong> with <span class="target" id="index-1"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PHP_INI_SCAN_DIR</span></code> to
<a class="reference external" href="https://www.php.net/manual/en/configuration.file.php">scan a custom directory</a>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;hello-world&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/public/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;index.php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;environment&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;PHP_INI_SCAN_DIR&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_ph title="Path separator">:</span>/tmp/php.inis/&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Mind that the colon that prefixes the value here is a path separator;
it causes PHP to scan the directory preconfigured with the
<code class="xref std std-option docutils literal notranslate"><span class="pre">--with-config-file-scan-dir</span></code> option,
which is usually <strong>/etc/php.d/</strong>,
and then the directory you set here, which is <strong>/tmp/php.inis/</strong>.
To skip the preconfigured directory, drop the <strong>:</strong> prefix.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Values in <strong>options</strong> must be strings
(for example, <strong>“max_file_uploads”: “4”</strong>,
not <strong>“max_file_uploads”: 4</strong>);
for boolean flags,
use <strong>“0”</strong> and <strong>“1”</strong> only.
For details aof <strong>PHP_INI_*</strong> modes,
see the
<a class="reference external" href="https://www.php.net/manual/en/configuration.changes.modes.php">PHP docs</a>.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unit implements the <strong>fastcgi_finish_request()</strong> <a class="reference external" href="https://www.php.net/manual/en/function.fastcgi-finish-request.php">function</a> in a
manner similar to PHP-FPM.</p>
</div>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/blogs/scripts/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-blogs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www-blogs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;options&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;file&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/etc/php.ini&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;admin&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;memory_limit&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;256M&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;variables_order&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EGPCS&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;display_errors&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="targets">
<span id="configuration-php-targets"></span><h4>Targets<a class="headerlink" href="#targets" title="Permalink to this heading">§</a></h4>
<p>You can configure up to 254 individual entry points
for a single PHP app:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;php-app&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;php&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;front&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;front.php&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/apps/php-app/front/&quot;</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;back&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;back.php&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;root&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/apps/php-app/back/&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each target is an object
that specifies <strong>root</strong>
and can define <strong>index</strong> or <strong>script</strong>
just like a regular app does.
Targets can be used by the <strong>pass</strong> options
in listeners and routes
to serve requests:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;127.0.0.1:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php-app/front&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;127.0.0.1:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/back&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/php-app/back&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>App-wide settings
(<strong>isolation</strong>, <strong>limits</strong>, <strong>options</strong>, <strong>processes</strong>)
are shared by all targets within the app.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you specify <strong>targets</strong>,
there should be no <strong>root</strong>, <strong>index</strong>, or <strong>script</strong>
defined at the app level.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For PHP-based examples,
see our
<a class="reference internal" href="../howto/cakephp/"><span class="doc">CakePHP</span></a>,
<a class="reference internal" href="../howto/codeigniter/"><span class="doc">CodeIgniter</span></a>,
<a class="reference internal" href="../howto/dokuwiki/"><span class="doc">DokuWiki</span></a>,
<a class="reference internal" href="../howto/drupal/"><span class="doc">Drupal</span></a>,
<a class="reference internal" href="../howto/laravel/"><span class="doc">Laravel</span></a>,
<a class="reference internal" href="../howto/lumen/"><span class="doc">Lumen</span></a>,
<a class="reference internal" href="../howto/matomo/"><span class="doc">Matomo</span></a>,
<a class="reference internal" href="../howto/mediawiki/"><span class="doc">MediaWiki</span></a>,
<a class="reference internal" href="../howto/modx/"><span class="doc">MODX</span></a>,
<a class="reference internal" href="../howto/nextcloud/"><span class="doc">NextCloud</span></a>,
<a class="reference internal" href="../howto/phpbb/"><span class="doc">phpBB</span></a>,
<a class="reference internal" href="../howto/phpmyadmin/"><span class="doc">phpMyAdmin</span></a>,
<a class="reference internal" href="../howto/roundcube/"><span class="doc">Roundcube</span></a>,
<a class="reference internal" href="../howto/symfony/"><span class="doc">Symfony</span></a>,
<a class="reference internal" href="../howto/wordpress/"><span class="doc">WordPress</span></a>,
and
<a class="reference internal" href="../howto/yii/"><span class="doc">Yii</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-php"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="python">
<span id="configuration-python"></span><h3>Python<a class="headerlink" href="#python" title="Permalink to this heading">§</a></h3>
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">Python language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>module</strong> (required)</td>
<td>String;
app’s module name.
This module is
<a class="reference external" href="https://docs.python.org/3/reference/import.html">imported</a>
by Unit
the usual Python way.</td>
</tr>
<tr class="row-odd"><td><strong>callable</strong></td>
<td><p class="first">String;
name of the <strong>module</strong>-based callable
that Unit runs as the app.</p>
<p class="last">The default is <strong>application</strong>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>factory</strong></td>
<td><p class="first">Boolean:
when enabled, Unit treats <strong>callable</strong> as a factory.</p>
<p>The default is <strong>false</strong>.</p>
<p><strong>Note:</strong> Unit does <em>not</em> support passing arguments to factories.</p>
<p class="last"><em>(since 1.33.0)</em></p>
</td>
</tr>
<tr class="row-odd"><td><strong>home</strong></td>
<td><p class="first">String;
path to the app’s
<a class="reference external" href="https://packaging.python.org/en/latest/tutorials/installing-packages/#creating-virtual-environments">virtual environment</a>.
Absolute or relative to <strong>working_directory</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Python version used to run the app
is determined by <strong>type</strong>;
for performance,
Unit doesn’t use the command-line interpreter
from the virtual environment.</p>
</div>
<details id=encodings-error_
            onclick="window.location.hash='#encodings-error'">
            <summary><span>ImportError: No module named 'encodings'</span></summary><div class="last docutils container">
<p>Seeing this in Unit’s
<a class="reference internal" href="../troubleshooting/#troubleshooting-log"><span class="std std-ref">log</span></a>
after you set up <strong>home</strong> for your app?
This usually occurs
if the interpreter can’t use the virtual environment,
possible reasons including:</p>
<ul>
<li><p class="first">Version mismatch
between the <strong>type</strong> setting
and the virtual environment;
check the environment’s version:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">source</span><span class="w"> </span><span class=nxt_ph title="Path to the virtual environment; use a real path in your commands">/path/to/venv/</span>bin/activate
<span class="gp gp-VirtualEnv">(venv)</span> <span class="gp">$ </span>python<span class="w"> </span>--version
</pre></div>
</div>
</li>
<li><p class="first">Unit’s unprivileged user
(usually <strong>unit</strong>)
having no access to the environment’s files;
assign the necessary rights:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>chown<span class="w"> </span>-R<span class="w"> </span><span class=nxt_hint title="User and group that Unit's router runs as by default">unit:unit</span><span class="w"> </span><span class=nxt_ph title="Path to the virtual environment; use a real path in your commands">/path/to/venv/</span>
</pre></div>
</div>
</li>
</ul>
</div>
</details></td>
</tr>
<tr class="row-even"><td><strong>path</strong></td>
<td>String or an array of strings;
additional Python module lookup paths.
These values are prepended to <strong>sys.path</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>prefix</strong></td>
<td>String;
<strong>SCRIPT_NAME</strong> context value for WSGI
or the <strong>root_path</strong> context value for ASGI.
Should start with a slash
(<strong>/</strong>).</td>
</tr>
<tr class="row-even"><td><strong>protocol</strong></td>
<td>String;
hints Unit that the app uses a certain interface.
Can be <strong>asgi</strong> or <strong>wsgi</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>targets</strong></td>
<td>Object;
app sections with
<a class="reference internal" href="#configuration-python-targets"><span class="std std-ref">custom</span></a>
<strong>module</strong> and <strong>callable</strong> values.</td>
</tr>
<tr class="row-even"><td><strong>thread_stack_size</strong></td>
<td><p class="first">Integer;
stack size of a worker thread
(in bytes,
multiple of memory page size;
the minimum value is usually architecture specific).</p>
<p class="last">The default is usually system dependent
and can be set with <strong class="program">ulimit -s &lt;SIZE_KB&gt;</strong>.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>threads</strong></td>
<td><p class="first">Integer;
number of worker threads
per <a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>.
When started,
each app process creates this number of threads
to handle requests.</p>
<p class="last">The default is <strong>1</strong>.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;working_directory&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/store/cart/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Added to sys.path for lookup; store the application module within this directory">/www/store/</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;home&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Path where the virtual environment is located; here, it's relative to the working directory">.virtualenv/</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Looks for a 'run.py' module in /www/store/cart/">cart.run</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;callable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;prefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_hint title="Sets the SCRIPT_NAME or root_path context value">/cart</span>&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This snippet runs the <strong>app</strong> callable
from the <strong>/www/store/cart/run.py</strong> module
with <strong>/www/store/cart/</strong> as the working directory
and <strong>/www/store/.virtualenv/</strong> as the virtual environment;
the <strong>path</strong> value
accommodates for situations
when some modules of the app
are imported
from outside the <strong>cart/</strong> subdirectory.</p>
<p id="configuration-python-asgi">You can provide the callable in two forms.
The first one uses WSGI
(<a class="reference external" href="https://peps.python.org/pep-0333/">PEP 333</a>
or <a class="reference external" href="https://peps.python.org/pep-3333/">PEP 3333</a>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="n">start_response</span><span class="p">(</span><span class="s1">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">)])</span>
    <span class="k">yield</span> <span class="sa">b</span><span class="s1">&#39;Hello, WSGI</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>The second one,
supported with Python 3.5+,
uses
<a class="reference external" href="https://asgi.readthedocs.io/en/latest/">ASGI</a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>

    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;http.response.start&#39;</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="mi">200</span>
    <span class="p">})</span>

    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;http.response.body&#39;</span><span class="p">,</span>
        <span class="s1">&#39;body&#39;</span><span class="p">:</span> <span class="sa">b</span><span class="s1">&#39;Hello, ASGI</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">})</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Legacy
<a class="reference external" href="https://asgi.readthedocs.io/en/latest/specs/main.html#legacy-applications">two-callable</a>
ASGI 2.0 applications
were not supported prior to Unit 1.21.0.</p>
</div>
<p>Choose either one according to your needs;
Unit tries to infer your choice automatically.
If this inference fails,
use the <strong>protocol</strong> option
to set the interface explicitly.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <strong>prefix</strong> option
controls the <strong>SCRIPT_NAME</strong>
(<a class="reference external" href="https://wsgi.readthedocs.io/en/latest/definitions.html">WSGI</a>)
or <strong>root_path</strong>
(<a class="reference external" href="https://asgi.readthedocs.io/en/latest/specs/www.html#http-connection-scope">ASGI</a>)
setting in Python’s context,
allowing to route requests
regardless of the app’s factual path.</p>
</div>
<div class="section" id="configuration-python-targets">
<span id="id1"></span><h4>Targets<a class="headerlink" href="#configuration-python-targets" title="Permalink to this heading">§</a></h4>
<p>You can configure up to 254 individual entry points
for a single Python app:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;python-app&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/apps/python-app/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;front&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;front.wsgi&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;callable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span>
<span class="w">                </span><span class="p">},</span>

<span class="w">                </span><span class="nt">&quot;back&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;back.wsgi&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nt">&quot;callable&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;app&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Each target is an object
that specifies <strong>module</strong>
and can also define <strong>callable</strong> and <strong>prefix</strong>
just like a regular app does.
Targets can be used by the <strong>pass</strong> options
in listeners and routes
to serve requests:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;127.0.0.1:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/python-app/front&quot;</span>
<span class="w">        </span><span class="p">},</span>

<span class="w">        </span><span class="nt">&quot;127.0.0.1:80&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;routes&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>

<span class="w">    </span><span class="nt">&quot;routes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;uri&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/back&quot;</span>
<span class="w">            </span><span class="p">},</span>

<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/python-app/back&quot;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <strong>home</strong>, <strong>path</strong>, <strong>protocol</strong>, <strong>threads</strong>, and
<strong>thread_stack_size</strong> settings
are shared by all targets in the app.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you specify <strong>targets</strong>,
there should be no <strong>module</strong> or <strong>callable</strong>
defined at the app level.
Moreover, you can’t combine WSGI and ASGI targets
within a single app.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Python-based examples,
see our
<a class="reference internal" href="../howto/bottle/"><span class="doc">Bottle</span></a>,
<a class="reference internal" href="../howto/datasette/"><span class="doc">Datasette</span></a>,
<a class="reference internal" href="../howto/django/"><span class="doc">Django</span></a>,
<a class="reference internal" href="../howto/djangochannels/"><span class="doc">Django Channels</span></a>,
<a class="reference internal" href="../howto/falcon/"><span class="doc">Falcon</span></a>,
<a class="reference internal" href="../howto/fastapi/"><span class="doc">FastAPI</span></a>,
<a class="reference internal" href="../howto/flask/"><span class="doc">Flask</span></a>,
<a class="reference internal" href="../howto/guillotina/"><span class="doc">Guillotina</span></a>,
<a class="reference internal" href="../howto/mailman/"><span class="doc">Mailman Web</span></a>,
<a class="reference internal" href="../howto/mercurial/"><span class="doc">Mercurial</span></a>,
<a class="reference internal" href="../howto/moin/"><span class="doc">MoinMoin</span></a>,
<a class="reference internal" href="../howto/plone/"><span class="doc">Plone</span></a>,
<a class="reference internal" href="../howto/pyramid/"><span class="doc">Pyramid</span></a>,
<a class="reference internal" href="../howto/quart/"><span class="doc">Quart</span></a>,
<a class="reference internal" href="../howto/responder/"><span class="doc">Responder</span></a>,
<a class="reference internal" href="../howto/reviewboard/"><span class="doc">Review Board</span></a>,
<a class="reference internal" href="../howto/sanic/"><span class="doc">Sanic</span></a>,
<a class="reference internal" href="../howto/starlette/"><span class="doc">Starlette</span></a>,
<a class="reference internal" href="../howto/trac/"><span class="doc">Trac</span></a>,
and
<a class="reference internal" href="../howto/zope/"><span class="doc">Zope</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-python"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
</div>
<div class="section" id="ruby">
<span id="configuration-ruby"></span><h3>Ruby<a class="headerlink" href="#ruby" title="Permalink to this heading">§</a></h3>
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">Ruby language module</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Unit uses the
<a class="reference external" href="https://rack.github.io">Rack</a>
interface
to run Ruby scripts;
you need to have it installed as well:</p>
<div class="last highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gem<span class="w"> </span>install<span class="w"> </span>rack
</pre></div>
</div>
</div>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>script</strong> (required)</td>
<td>String; rack script pathname, including the <strong>.ru</strong> extension,
for instance: <strong>/www/rubyapp/script.ru</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>hooks</strong></td>
<td>String; pathname of the <strong>.rb</strong> file setting the event hooks invoked
during the app’s lifecycle.</td>
</tr>
<tr class="row-even"><td><strong>threads</strong></td>
<td>Integer; number of worker threads per
<a class="reference internal" href="../howto/security/#sec-processes"><span class="std std-ref">app process</span></a>. When started, each app process
creates this number of threads to handle requests. The default is <strong>1</strong>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ruby&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;processes&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;group&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;www&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;script&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/cms/config.ru&quot;</span><span class="p">,</span>
<span class="w">   </span><span class="nt">&quot;hooks&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hooks.rb&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <strong>hooks</strong> script
is evaluated when the app starts.
If set, it can define blocks of Ruby code named
<strong>on_worker_boot</strong>,
<strong>on_worker_shutdown</strong>,
<strong>on_thread_boot</strong>,
or <strong>on_thread_shutdown</strong>.
If provided,
these blocks are called
at the respective points
of the app’s lifecycle,
for example:</p>
<div class="highlight-ruby notranslate"><div class="highlight"><pre><span></span><span class="vi">@mutex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Mutex</span><span class="o">.</span><span class="n">new</span>

<span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./hooks.</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hooks evaluated&quot;</span><span class="p">)</span>
<span class="c1"># Runs once at app load.</span>

<span class="n">on_worker_boot</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span><span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./worker_boot.</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;worker boot&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1"># Runs at worker process boot.</span>

<span class="n">on_thread_boot</span><span class="w"> </span><span class="k">do</span>
<span class="w">   </span><span class="vi">@mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="c1"># Avoids a race condition that may crash the app.</span>
<span class="w">      </span><span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./thread_boot.</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="w">                  </span><span class="s2">&quot;thread boot&quot;</span><span class="p">)</span>
<span class="w">   </span><span class="k">end</span>
<span class="k">end</span>
<span class="c1"># Runs at worker thread boot.</span>

<span class="n">on_thread_shutdown</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="vi">@mutex</span><span class="o">.</span><span class="n">synchronize</span><span class="w"> </span><span class="k">do</span>
<span class="w">        </span><span class="c1"># Avoids a race condition that may crash the app.</span>
<span class="w">        </span><span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./thread_shutdown.</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="no">Thread</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">object_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="w">                   </span><span class="s2">&quot;thread shutdown&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
<span class="c1"># Runs at worker thread shutdown.</span>

<span class="n">on_worker_shutdown</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="no">File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;./worker_shutdown.</span><span class="si">#{</span><span class="no">Process</span><span class="o">.</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;worker shutdown&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="c1"># Runs at worker process shutdown.</span>
</pre></div>
</div>
<p>Use these hooks
to add custom runtime logic
to your app.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For Ruby-based examples,
see our
<a class="reference internal" href="../howto/rails/"><span class="doc">Ruby on Rails</span></a>
and
<a class="reference internal" href="../howto/redmine/"><span class="doc">Redmine</span></a>
howtos or a basic
<a class="reference internal" href="../howto/samples/#sample-ruby"><span class="std std-ref">sample</span></a>.</p>
</div>
</div>
<div class="section" id="webassembly">
<span id="configuration-wasm"></span><h3>WebAssembly<a class="headerlink" href="#webassembly" title="Permalink to this heading">§</a></h3>
<div class="nxt_tabs nxt_toc docutils container">
<input name=unit-wasm type=radio
            id=unit-wasm_0 class=nojs checked/>
            <label for=unit-wasm_0 id=unit-wasm-wasm-wasi-component>
            <a href=#unit-wasm-wasm-wasi-component onclick="nxt_tab_click(event)">wasm-wasi-component</a></label><div class="docutils container">
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">WebAssembly language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>component</strong> (required)</td>
<td>String; WebAssembly component pathname, including the <strong>.wasm</strong>
extension, for instance: “/var/www/wasm/component.wasm”</td>
</tr>
<tr class="row-odd"><td><strong>access</strong></td>
<td><p class="first">Object;  its only array member, <strong>filesystem</strong>, lists
directories to which the application has access:</p>
<div class="last highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;filesystem&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;/var/tmp/&quot;</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;listeners&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;127.0.0.1:8080&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;pass&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;applications/wasm&quot;</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;applications&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="nt">&quot;wasm&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;wasm-wasi-component&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;component&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/www/app/component.wasm&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;filesystem&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">           </span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
<span class="w">           </span><span class="s2">&quot;/var/tmp/&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">     </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A good, first Rust-based project is available at
<a class="reference external" href="https://github.com/sunfishcode/hello-wasi-http">sunfishcode/hello-wasi-http</a>.
It also includes all the important steps to get started with WebAssembly, WASI, and Rust.</p>
</div>
</div>
<input name=unit-wasm type=radio
            id=unit-wasm_1 class=nojs />
            <label for=unit-wasm_1 id=unit-wasm-unit-wasm>
            <a href=#unit-wasm-unit-wasm onclick="nxt_tab_click(event)">unit-wasm</a></label><div class="docutils container">
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <cite>unit-wasm</cite> module is deprecated.
We recommend using <cite>wasm-wasi-component</cite> instead, which supports
WebAssembly Components using standard WASI 0.2 interfaces.
The <cite>wasm-wasi-component</cite> module is available in Unit 1.32 and later.</p>
</div>
<p>First, make sure to install Unit along with the
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">WebAssembly language module</span></a>.</p>
<p>Besides the
<a class="reference internal" href="#configuration-apps-common"><span class="std std-ref">common options</span></a>,
you have:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>module</strong> (required)</td>
<td>String; WebAssembly module pathname, including the <strong>.wasm</strong> extension,
for instance: <strong>applications/wasmapp/module.wasm</strong>.</td>
</tr>
<tr class="row-odd"><td><strong>request_handler</strong> (required)</td>
<td><p class="first">String; name of the request handler function. If you use Unit
with the official <strong class="program">unit-wasm</strong> <a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific; see the
<a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a> documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">The runtime calls this handler, providing the address of the
shared memory block used to pass data in and out the app.</p>
</td>
</tr>
<tr class="row-even"><td><strong>malloc_handler</strong> (required)</td>
<td><p class="first">String; name of the memory allocator function.  See note above regarding
language-specific handlers in the official <cite>unit-wasm</cite> package.</p>
<p class="last">The runtime calls this handler at language module startup to allocate
the shared memory block used to pass data in and out the app.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>free_handler</strong> (required)</td>
<td><p class="first">String;  name of the memory deallocator function.  See note above regarding
language-specific handlers in the official <cite>unit-wasm</cite> package.</p>
<p class="last">The runtime calls this handler at language module shutdown to free
the shared memory block used to pass data in and out the app.</p>
</td>
</tr>
<tr class="row-even"><td><strong>access</strong></td>
<td><p class="first">Object;  its only array member, <strong>filesystem</strong>, lists directories
the application can access:</p>
<div class="last highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;filesystem&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;/var/tmp/&quot;</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><strong>module_init_handler</strong>,</td>
<td><p class="first">String;
name of the module initilization function.
If you use Unit with the official <strong class="program">unit-wasm</strong>
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific;
see the <a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a>
documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">It is invoked by the WebAssembly language module
at language module startup,
after the WebAssembly module was initialized.</p>
</td>
</tr>
<tr class="row-even"><td><strong>module_end_handler</strong></td>
<td><p class="first">String;
name of the module finalization function.
If you use Unit with the official <strong class="program">unit-wasm</strong>
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific;
see the <a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a>
documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">It is invoked by the WebAssembly language module
at language module shutdown.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>request_init_handler</strong></td>
<td><p class="first">String;
name of the request initialization function.
If you use Unit with the official <strong class="program">unit-wasm</strong>
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific;
see the <a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a>
documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">It is invoked by the WebAssembly language module
at the start of each request.</p>
</td>
</tr>
<tr class="row-even"><td><strong>request_end_handler</strong></td>
<td><p class="first">String;
name of the request finalization function.
If you use Unit with the official <strong class="program">unit-wasm</strong>
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific;
see the <a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a>
documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">It is invoked by the WebAssembly language module
at the end of each request,
when the headers and the request body were received.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>response_end_handler</strong></td>
<td><p class="first">String;
name of the response finalization function.
If you use Unit with the official <strong class="program">unit-wasm</strong>
<a class="reference internal" href="../installation/#installation-precomp-pkgs"><span class="std std-ref">package</span></a>,
the value is language specific;
see the <a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a>
documentation for details.
Otherwise, use the name of your custom implementation.</p>
<p class="last">It is invoked by the WebAssembly language module
at the end of each response,
when the headers and the response body were sent.</p>
</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;wasm&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/www/webassembly/unitapp.wasm&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;request_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_request_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;malloc_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_malloc_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;free_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_free_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;access&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;filesystem&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="s2">&quot;/tmp/&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;/var/tmp/&quot;</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;module_init_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_module_init_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;module_end_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_module_end_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;request_init_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_request_init_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;request_end_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_request_end_handler&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;response_end_handler&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;my_custom_response_end_handler&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Use these handlers to add custom runtime logic to your app; for a detailed
discussion of their usage and requirements, see the
<a class="reference external" href="https://github.com/nginx/unit-wasm/">SDK</a> source code and documentation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For WASM-based examples, see our <a class="reference internal" href="../howto/samples/#sample-wasm"><span class="std std-ref">Rust and C samples</span></a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="settings">
<span id="configuration-stngs"></span><h2>Settings<a class="headerlink" href="#settings" title="Permalink to this heading">§</a></h2>
<p>Unit has a global <strong>settings</strong> configuration object
that stores instance-wide preferences.</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>listen_threads</strong></td>
<td><p class="first">Integer;
controls the number of router threads created to handle client
connections. Each thread includes all the configured listeners.</p>
<p>By default, we create as many threads as the number of CPUs that
are available to run on.</p>
<p class="last"><em>(since 1.33.0)</em></p>
</td>
</tr>
<tr class="row-odd"><td><strong>http</strong></td>
<td>Object;
fine-tunes handling of HTTP requests
from the clients.</td>
</tr>
<tr class="row-even"><td><strong>js_module</strong></td>
<td>String or an array of strings;
lists enabled
<strong class="program">njs</strong>
<a class="reference internal" href="../scripting/"><span class="doc">modules</span></a>,
uploaded
via the <a class="reference internal" href="../controlapi/"><span class="doc">control API</span></a>.</td>
</tr>
</tbody>
</table>
<p>In turn, the <strong>http</strong> option exposes the following settings:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>body_read_timeout</strong></td>
<td><p class="first">Maximum number of seconds
to read data from the body
of a client’s request.
This is the interval
between consecutive read operations,
not the time to read the entire body.
If Unit doesn’t receive any data
from the client
within this interval,
it returns a 408 “Request Timeout” response.</p>
<p class="last">The default is 30.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>discard_unsafe_fields</strong></td>
<td><p class="first">Boolean;
controls header field name parsing.
If it’s set to <strong>true</strong>,
Unit only processes header names
made of alphanumeric characters and hyphens
(see
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110#section-16.3.1-6">RFC 9110</a>);
otherwise,
these characters are also permitted:
<strong>.!#$%&amp;’*+^_`|~</strong>.</p>
<p class="last">The default is <strong>true</strong>.</p>
</td>
</tr>
<tr class="row-even"><td><strong>header_read_timeout</strong></td>
<td><p class="first">Maximum number of seconds
to read the header
of a client’s request.
If Unit doesn’t receive the entire header
from the client
within this interval,
it returns a 408 “Request Timeout” response.</p>
<p class="last">The default is 30.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>idle_timeout</strong></td>
<td><p class="first">Maximum number of seconds
between requests
in a keep-alive connection.
If no new requests
arrive within this interval,
Unit returns a 408 “Request Timeout” response
and closes the connection.</p>
<p class="last">The default is 180.</p>
</td>
</tr>
<tr class="row-even"><td><strong>log_route</strong></td>
<td><p class="first">Boolean;
enables or disables
<a class="reference internal" href="../troubleshooting/#troubleshooting-router-log"><span class="std std-ref">router logging</span></a>.</p>
<p class="last">The default is <strong>false</strong> (disabled).</p>
</td>
</tr>
<tr class="row-odd"><td><strong>max_body_size</strong></td>
<td><p class="first">Maximum number of bytes
in the body of a client’s request.
If the body size exceeds this value,
Unit returns a 413 “Payload Too Large” response
and closes the connection.</p>
<p class="last">The default is 8388608 (8 MB).</p>
</td>
</tr>
<tr class="row-even"><td><strong>send_timeout</strong></td>
<td><p class="first">Maximum number of seconds
to transmit data
as a response to the client.
This is the interval
between consecutive transmissions,
not the time for the entire response.
If no data
is sent to the client
within this interval,
Unit closes the connection.</p>
<p class="last">The default is 30.</p>
</td>
</tr>
<tr class="row-odd"><td><strong>server_version</strong></td>
<td><p class="first">Boolean;
if set to <strong>false</strong>,
Unit omits version information
in its <strong>Server</strong> response
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc9110.html#section-10.2.4">header fields</a>.</p>
<p>The default is <strong>true</strong>.</p>
<p class="last"><em>(since 1.30.0)</em></p>
</td>
</tr>
<tr class="row-even"><td><strong>static</strong></td>
<td><p class="first">Object;
configures static asset handling.
Has a single object option named <strong>mime_types</strong>
that defines specific
<a class="reference external" href="https://www.iana.org/assignments/media-types/media-types.xhtml">MIME types</a>
as options.
Their values
can be strings or arrays of strings;
each string must specify a filename extension
or a specific filename
that’s included in the MIME type.
You can override default MIME types
or add new types:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;{&quot;text/x-code&quot;: [&quot;.c&quot;, &quot;.h&quot;]}&#39;</span><span class="w"> </span><span class=nxt_ph title="Path to Unit's control socket in your installation">/path/to/control.unit.sock</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>http://localhost/config/settings/http/static/mime_types
<span class="go">{</span>
<span class="go">       &quot;success&quot;: &quot;Reconfiguration done.&quot;</span>
<span class="go">}</span>
</pre></div>
</div>
<p class="last" id="configuration-mime">Defaults:
<strong>.aac</strong>, <strong>.apng</strong>, <strong>.atom</strong>,
<strong>.avi</strong>, <strong>.avif</strong>, <strong>avifs</strong>, <strong>.bin</strong>, <strong>.css</strong>,
<strong>.deb</strong>, <strong>.dll</strong>, <strong>.exe</strong>, <strong>.flac</strong>, <strong>.gif</strong>,
<strong>.htm</strong>, <strong>.html</strong>, <strong>.ico</strong>, <strong>.img</strong>, <strong>.iso</strong>,
<strong>.jpeg</strong>, <strong>.jpg</strong>, <strong>.js</strong>, <strong>.json</strong>, <strong>.md</strong>,
<strong>.mid</strong>, <strong>.midi</strong>, <strong>.mp3</strong>, <strong>.mp4</strong>, <strong>.mpeg</strong>,
<strong>.mpg</strong>, <strong>.msi</strong>, <strong>.ogg</strong>, <strong>.otf</strong>, <strong>.pdf</strong>,
<strong>.php</strong>, <strong>.png</strong>, <strong>.rpm</strong>, <strong>.rss</strong>, <strong>.rst</strong>,
<strong>.svg</strong>, <strong>.ttf</strong>, <strong>.txt</strong>, <strong>.wav</strong>, <strong>.webm</strong>,
<strong>.webp</strong>, <strong>.woff2</strong>, <strong>.woff</strong>, <strong>.xml</strong>, and
<strong>.zip</strong>.</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="access-log">
<span id="configuration-access-log"></span><h2>Access log<a class="headerlink" href="#access-log" title="Permalink to this heading">§</a></h2>
<p>To enable basic access logging,
specify the log file path
in the <strong>access_log</strong> option
of the <strong>config</strong> object.</p>
<p>In the example below,
all requests will be logged
to <strong>/var/log/access.log</strong>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;&quot;/var/log/access.log&quot;&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>--unix-socket<span class="w"> </span><span class=nxt_ph title="Path to Unit's control socket in your installation">/path/to/control.unit.sock</span><span class="w"> </span><span class="se">\</span>
<span class="w">       </span>http://localhost/config/access_log

<span class="go">    {</span>
<span class="go">        &quot;success&quot;: &quot;Reconfiguration done.&quot;</span>
<span class="go">    }</span>
</pre></div>
</div>
<p>By default, the log is written in the
<a class="reference external" href="https://httpd.apache.org/docs/2.2/logs.html#combined">Combined Log Format</a>.
Example of a CLF line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>127.0.0.1 - - [21/Oct/2015:16:29:00 -0700] &quot;GET / HTTP/1.1&quot; 200 6022 &quot;http://example.com/links.html&quot; &quot;Godzilla/5.0 (X11; Minix i286) Firefox/42&quot;
</pre></div>
</div>
<div class="section" id="custom-log-formatting">
<h3>Custom log formatting<a class="headerlink" href="#custom-log-formatting" title="Permalink to this heading">§</a></h3>
<p id="custom-log-format">The <strong>access_log</strong> option
can be also set to an object
to customize both the log path
and its format:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>format</strong></td>
<td>String;
sets the log format.
Besides arbitrary text,
can contain any
<a class="reference internal" href="#configuration-variables"><span class="std std-ref">variables</span></a>
Unit supports.</td>
</tr>
<tr class="row-odd"><td><strong>path</strong></td>
<td>String;
pathname of the access log file.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;access_log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/log/unit/access.log&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_var>$remote_addr</span> - - [<span class=nxt_var>$time_local</span>] \&quot;<span class=nxt_var>$request_line</span>\&quot; <span class=nxt_var>$status</span> <span class=nxt_var>$body_bytes_sent</span> \&quot;<span class=nxt_var>$header_referer</span>\&quot; \&quot;<span class=nxt_var>$header_user_agent</span>\&quot;&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>By a neat coincidence,
the above <strong>format</strong>
is the default setting.
Also, mind that the log entry
is formed <em>after</em> the request has been handled.</p>
<p>Besides
<a class="reference internal" href="#configuration-variables-native"><span class="std std-ref">built-in variables</span></a>,
you can use <strong class="program">njs</strong>
<a class="reference internal" href="../scripting/"><span class="doc">templates</span></a>
to define the log format:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;access_log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/var/log/unit/basic_access.log&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class="sb">`</span><span class="si">${</span><span class="nx">host</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">uri</span><span class="si">}</span><span class="sb">`</span>&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="conditional-access-log">
<h3>Conditional access log<a class="headerlink" href="#conditional-access-log" title="Permalink to this heading">§</a></h3>
<p id="id2">The <strong>access_log</strong> can be dynamically turned on and off by using the <strong>if</strong> option:</p>
<table border="1" class="docutils align-default">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Option</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>if</strong></td>
<td>if the value is empty, 0, false, null, or undefined,
the logs will not be recorded.</td>
</tr>
</tbody>
</table>
<p>This feature lets users set conditions to determine whether access logs are
recorded. The <strong>if</strong> option supports a string and JavaScript code.
If its value is empty, 0, false, null, or undefined, the logs will not be
recorded. And the ‘!’ as a prefix inverses the condition.</p>
<p>Example without njs:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;access_log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;if&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class=nxt_var>$cookie_session</span>&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>All requests using a session cookie named <strong>session</strong> will be logged.</p>
<p>We can add ! to inverse the condition.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;access_log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;if&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;!<span class=nxt_var>$cookie_session</span>&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now, all requests without a session cookie will be logged.</p>
<p>Example with njs and the use of a template literal:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;access_log&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;if&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;<span class="sb">`</span><span class="si">${</span><span class="nx">uri</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;/health&#39;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="si">}</span><span class="sb">`</span>&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


    
    <div class="nxt_edit_link"><a href="https://github.com/nginx/unit-docs/edit/main/source/configuration\index.rst"><div></div>Edit this page</a></div>
    
    
    <div class="nxt_discuss_link"><a href="https://github.com/nginx/unit/discussions/"><div></div>Discuss on GitHub</a></div>
    
    <p id="footer">
        © 2017-2024 <a href="https://www.nginx.com/">NGINX, Inc.</a>
    </p>
    <p id="tecookie">
        <!-- TrustArc cookie preferences link -->
        <span id="teconsent"></span>
        <!-- End TrustArc cookie preferences link -->
    </p>
</div>
</div>
<!-- TrustArc cookie consent -->
<div id="consent_blackbar" style="position:fixed;top:0px;width:100%">
<!-- End TrustArc cookie consent -->
</body>
</html>